-- VERSION:0.4 --SDATE:18/04/2015 --DESC:ADDED LMC_CONTRACT_DETAILS CREATE QUERY --DONE BY:RL
-- VERSION:0.3 --SDATE:26/03/2015 --DESC:REMOVED LMC_USER_ACCESS,LMC_EMPLOYEE_DETAILS,LMC_EMPLOYEE_ATTACHMENT_DETAILS TABLE & ADDED LMC_WORKER_DESIGNATION,LMC_EMPLOYEE_TEAM_DETAILS,LMC_CONTRACT_LOCATION_DETAILS TABLE --DONE BY:RL
-- VERSION:0.2 --SDATE:16/03/2015 --EDATE:16/03/2015 --DESC:LMC_EMPLOYEE_ATTACHMENT_DETAILS TABLE CREATION, REMOVED UA_FILE_NAME USER ACCESS TABLE --DONE BY:RL
-- VERSION:0.1 --SDATE:29/01/2015 --EDATE:29/01/2015 --ISSUE:2 --COMMENT NO:1 --DESC:PATCH DOMAIN TABLE CREATION --DONE BY:RL

DROP PROCEDURE IF EXISTS SP_LMC_TS_USER_RIGHTS_TABLE_CREATION;
CREATE PROCEDURE SP_LMC_TS_USER_RIGHTS_TABLE_CREATION(
OUT SUCCESS_MESSAGE TEXT)

BEGIN

-- QUERY FOR ROLLBACK COMMAND
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		SET SUCCESS_MESSAGE=0;
	END;
	START TRANSACTION;

	SET FOREIGN_KEY_CHECKS = 0;
	SET SUCCESS_MESSAGE=0;
	SET AUTOCOMMIT=0;

-- LMC_MENU_PROFILE
	DROP TABLE IF EXISTS LMC_MENU_PROFILE;
	CREATE TABLE LMC_MENU_PROFILE(
	MP_ID INTEGER NOT NULL AUTO_INCREMENT,
	MP_MNAME VARCHAR(25) NOT NULL,
	MP_MSUB VARCHAR(50) NULL,
	MP_MSUBMENU	VARCHAR(60) NULL,
	MP_MFILENAME VARCHAR(100) NOT NULL,
	MP_SCRIPT_FLAG VARCHAR(1) NULL,
	PRIMARY KEY(MP_ID));

	SET @ALTER_MENU_PROFILE = (SELECT CONCAT('ALTER TABLE LMC_MENU_PROFILE AUTO_INCREMENT = 0'));
	PREPARE ALTER_MENU_PROFILE_STMT FROM @ALTER_MENU_PROFILE;
	EXECUTE ALTER_MENU_PROFILE_STMT;

-- ROLE_CREATION TABLE CREATION
	DROP TABLE IF EXISTS LMC_ROLE_CREATION;
	CREATE TABLE LMC_ROLE_CREATION(
	RC_ID INTEGER NOT NULL AUTO_INCREMENT,
	URC_ID INTEGER NOT NULL,
	RC_NAME	VARCHAR(15)	UNIQUE	NOT NULL,
	PRIMARY KEY(RC_ID));

	SET @ALTER_ROLE_CREATION = (SELECT CONCAT('ALTER TABLE LMC_ROLE_CREATION AUTO_INCREMENT = 0'));
	PREPARE ALTER_ROLE_CREATION_STMT FROM @ALTER_ROLE_CREATION;
	EXECUTE ALTER_ROLE_CREATION_STMT;

	
-- USER_LOGIN_DETAILS TABLE CREATION
	DROP TABLE IF EXISTS LMC_USER_LOGIN_DETAILS;
	CREATE TABLE LMC_USER_LOGIN_DETAILS(
	ULD_ID INTEGER NOT NULL AUTO_INCREMENT,
	ULD_USERNAME VARCHAR(40) UNIQUE	NOT NULL,	
	ULD_PASSWORD TEXT NOT NULL,
	RC_ID INTEGER NOT NULL,
	ULD_WORKER_NAME CHAR(40) NOT NULL,	
	ULD_WORKER_NO VARCHAR(10) UNIQUE NOT NULL,	
	ULD_IMAGE_FOLDER_ID	TEXT NOT NULL,	
	ULD_DOC_FOLDER_ID TEXT NOT NULL,	
	ULD_DOC_FILE_NAME TEXT NULL,
	ULD_TERMINATE_FLAG CHAR(1) NULL,
	ULD_EMAIL_ID VARCHAR(50) NOT NULL,
	ULD_ADDRESS	TEXT NOT NULL,
	ULD_NRIC_NO	VARCHAR(10) NOT NULL,
	ULD_MOBILE_NUMBER 	VARCHAR(8) NOT NULL,
	ULD_USERSTAMP INTEGER NOT NULL,	
	ULD_TIMESTAMP TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY(ULD_ID),
	FOREIGN KEY(RC_ID) REFERENCES LMC_ROLE_CREATION (RC_ID));

	SET @ALTER_USER_LOGIN_DETAILS = (SELECT CONCAT('ALTER TABLE LMC_USER_LOGIN_DETAILS AUTO_INCREMENT = 0'));
	PREPARE ALTER_USER_LOGIN_DETAILS_STMT FROM @ALTER_USER_LOGIN_DETAILS;
	EXECUTE ALTER_USER_LOGIN_DETAILS_STMT;	

-- LMC_USER_MENU_DETAILS
	DROP TABLE IF EXISTS LMC_USER_MENU_DETAILS;
	CREATE TABLE LMC_USER_MENU_DETAILS(
	UMD_ID INTEGER NOT NULL AUTO_INCREMENT,
	MP_ID INTEGER NOT NULL,
	RC_ID INTEGER NOT NULL,
	ULD_ID INTEGER NOT NULL,
	UMD_TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY(UMD_ID),
	FOREIGN KEY(MP_ID) REFERENCES LMC_MENU_PROFILE (MP_ID),
	FOREIGN KEY(RC_ID) REFERENCES LMC_ROLE_CREATION (RC_ID),
	FOREIGN KEY(ULD_ID) REFERENCES LMC_USER_LOGIN_DETAILS (ULD_ID));

	SET @ALTER_USER_MENU_DETAILS = (SELECT CONCAT('ALTER TABLE LMC_USER_MENU_DETAILS AUTO_INCREMENT = 0'));
	PREPARE ALTER_USER_MENU_DETAILS_STMT FROM @ALTER_USER_MENU_DETAILS;
	EXECUTE ALTER_USER_MENU_DETAILS_STMT;

-- LMC_BASIC_ROLE_PROFILE
	DROP TABLE IF EXISTS LMC_BASIC_ROLE_PROFILE;
	CREATE TABLE LMC_BASIC_ROLE_PROFILE(
	BRP_ID INTEGER NOT NULL AUTO_INCREMENT,
	URC_ID INTEGER NOT NULL,
	BRP_BR_ID INTEGER NOT NULL,
	ULD_ID INTEGER NOT NULL,
	BRP_TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY(BRP_ID),
	FOREIGN KEY(URC_ID) REFERENCES LMC_USER_RIGHTS_CONFIGURATION (URC_ID),
	FOREIGN KEY(BRP_BR_ID) REFERENCES LMC_USER_RIGHTS_CONFIGURATION (URC_ID),
	FOREIGN KEY(ULD_ID) REFERENCES LMC_USER_LOGIN_DETAILS (ULD_ID));

	SET @ALTER_BASIC_ROLE_PROFILE = (SELECT CONCAT('ALTER TABLE LMC_BASIC_ROLE_PROFILE AUTO_INCREMENT = 0'));
	PREPARE ALTER_BASIC_ROLE_PROFILE_STMT FROM @ALTER_BASIC_ROLE_PROFILE;
	EXECUTE ALTER_BASIC_ROLE_PROFILE_STMT;

-- LMC_BASIC_MENU_PROFILE
	DROP TABLE IF EXISTS LMC_BASIC_MENU_PROFILE;
	CREATE TABLE LMC_BASIC_MENU_PROFILE(
	BMP_ID INTEGER NOT NULL AUTO_INCREMENT,
	URC_ID INTEGER NOT NULL,
	MP_ID INTEGER NOT NULL,
	ULD_ID INTEGER NOT NULL,
	BMP_TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY(BMP_ID),
	FOREIGN KEY(URC_ID) REFERENCES LMC_USER_RIGHTS_CONFIGURATION (URC_ID),
	FOREIGN KEY(MP_ID) REFERENCES LMC_MENU_PROFILE (MP_ID),
	FOREIGN KEY(ULD_ID) REFERENCES LMC_USER_LOGIN_DETAILS (ULD_ID));

	SET @ALTER_BASIC_MENU_PROFILE = (SELECT CONCAT('ALTER TABLE LMC_BASIC_MENU_PROFILE AUTO_INCREMENT = 0'));
	PREPARE ALTER_BASIC_MENU_PROFILE_STMT FROM @ALTER_BASIC_MENU_PROFILE;
	EXECUTE ALTER_BASIC_MENU_PROFILE_STMT;

-- LMC_TEAM_CREATION
	DROP TABLE IF EXISTS LMC_TEAM_CREATION;
	CREATE TABLE LMC_TEAM_CREATION(
	TC_ID INTEGER NOT NULL AUTO_INCREMENT,
	TEAM_NAME VARCHAR(25) NOT NULL UNIQUE,
	ULD_ID INTEGER NOT NULL,
	TC_TIMESTAMP TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY(TC_ID),
	FOREIGN KEY(ULD_ID) REFERENCES LMC_USER_LOGIN_DETAILS (ULD_ID));

	SET @ALTER_TEAM_CREATION = (SELECT CONCAT('ALTER TABLE LMC_TEAM_CREATION AUTO_INCREMENT = 0'));
	PREPARE ALTER_TEAM_CREATIONSTMT FROM @ALTER_TEAM_CREATION;
	EXECUTE ALTER_TEAM_CREATIONSTMT;

-- LMC_WORKER_DESIGNATION
	DROP TABLE IF EXISTS LMC_WORKER_DESIGNATION;
	CREATE TABLE LMC_WORKER_DESIGNATION(
	WD_ID INTEGER NOT NULL AUTO_INCREMENT,
	WD_DESIGNATION VARCHAR(50) NOT NULL,
	PRIMARY KEY(WD_ID));

	SET @ALTER_LMC_WORKER_DESIGNATION = (SELECT CONCAT('ALTER TABLE LMC_WORKER_DESIGNATION AUTO_INCREMENT = 0'));
	PREPARE ALTER_LMC_WORKER_DESIGNATION_STMT FROM @ALTER_LMC_WORKER_DESIGNATION;
	EXECUTE ALTER_LMC_WORKER_DESIGNATION_STMT;

-- LMC_EMPLOYEE_TEAM_DETAILS
	DROP TABLE IF EXISTS LMC_EMPLOYEE_TEAM_DETAILS;
	CREATE TABLE LMC_EMPLOYEE_TEAM_DETAILS(
	ETD_ID INTEGER NOT NULL AUTO_INCREMENT,
	ULD_ID INTEGER NOT NULL,
	TC_ID INTEGER NOT NULL,
	WD_ID INTEGER NOT NULL,
	ETD_USERSTAMP_ID INTEGER NOT NULL,
	ETD_TIMESTAMP TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY(ETD_ID),
	FOREIGN KEY(ULD_ID) REFERENCES LMC_USER_LOGIN_DETAILS (ULD_ID),
	FOREIGN KEY(TC_ID) REFERENCES LMC_TEAM_CREATION (TC_ID),
	FOREIGN KEY(WD_ID) REFERENCES LMC_WORKER_DESIGNATION (WD_ID),
	FOREIGN KEY(ETD_USERSTAMP_ID) REFERENCES LMC_USER_LOGIN_DETAILS (ULD_ID));

	SET @ALTER_LMC_EMPLOYEE_TEAM_DETAILS = (SELECT CONCAT('ALTER TABLE LMC_EMPLOYEE_TEAM_DETAILS AUTO_INCREMENT = 0'));
	PREPARE ALTER_LMC_EMPLOYEE_TEAM_DETAILS_STMT FROM @ALTER_LMC_EMPLOYEE_TEAM_DETAILS;
	EXECUTE ALTER_LMC_EMPLOYEE_TEAM_DETAILS_STMT;

-- LMC_CONTRACT_DETAILS
	DROP TABLE IF EXISTS LMC_CONTRACT_DETAILS;
	CREATE TABLE LMC_CONTRACT_DETAILS(
	CLD_ID INTEGER NOT NULL AUTO_INCREMENT,
	CLD_CONTRACT_NO VARCHAR(15) NOT NULL,
	ULD_ID INTEGER NOT NULL,
	CLD_TIMESTAMP TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY(CLD_ID),
	FOREIGN KEY(ULD_ID) REFERENCES LMC_USER_LOGIN_DETAILS (ULD_ID));

	SET @ALTER_LMC_CONTRACT_DETAILS = (SELECT CONCAT('ALTER TABLE LMC_CONTRACT_DETAILS AUTO_INCREMENT = 0'));
	PREPARE ALTER_LMC_CONTRACT_DETAILS_STMT FROM @ALTER_LMC_CONTRACT_DETAILS;
	EXECUTE ALTER_LMC_CONTRACT_DETAILS_STMT;

-- LMC_TEMP_TABLE_DETAILS
	DROP TABLE IF EXISTS LMC_TEMP_TABLE_DETAILS;
	CREATE TABLE LMC_TEMP_TABLE_DETAILS(
	TTD_ID INTEGER NOT NULL AUTO_INCREMENT,
	TTD_DATE DATE NOT NULL,
	TTD_TABLE_NAME TEXT NOT NULL,
	TTD_TIMESTAMP TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY(TTD_ID));

	SET @ALTER_LMC_TEMP_TABLE_DETAILS = (SELECT CONCAT('ALTER TABLE LMC_TEMP_TABLE_DETAILS AUTO_INCREMENT = 0'));
	PREPARE ALTER_LMC_TEMP_TABLE_DETAILS_STMT FROM @ALTER_LMC_TEMP_TABLE_DETAILS;
	EXECUTE ALTER_LMC_TEMP_TABLE_DETAILS_STMT;

	SET SUCCESS_MESSAGE=1;
	
	COMMIT;
END;

CALL SP_LMC_TS_USER_RIGHTS_TABLE_CREATION(@SUCCESS_MESSAGE);
SELECT @SUCCESS_MESSAGE;

DROP PROCEDURE IF EXISTS SP_LMC_TS_USER_RIGHTS_TABLE_CREATION;