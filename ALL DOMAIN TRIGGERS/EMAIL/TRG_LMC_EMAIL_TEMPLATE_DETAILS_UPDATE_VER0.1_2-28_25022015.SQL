-- VER0.1 DATE:05/03/2015 ISSUE:2 COMMENT NO:1 -- >desc:CHANGED TABLE NAME --DONE BY:DHIVYA

-- VER0.1 STARTDATE:29/01/2015 ENDDATE:29/01/2015 ISSUE:2 COMMENT NO:1 -- >desc:TRIGGER TO INSERT VALUES IN TICKLER HISTORY TABLE AFTER UPDATING IN EMAIL_TEMPLATE_DTLS TABLE --DONE BY:RL

-- after update on EMAIL_TEMPLATE_DETAILS table this trigger will be executed
DROP TRIGGER IF EXISTS TRG_LMC_EMAIL_TEMPLATE_DETAILS_UPDATE;

CREATE TRIGGER TRG_LMC_EMAIL_TEMPLATE_DETAILS_UPDATE  

AFTER UPDATE ON LMC_EMAIL_TEMPLATE_DETAILS

FOR EACH ROW

BEGIN 
-- declaration for old_value and new_value to store it in TICKLER_HISTORY table
	DECLARE OLD_VALUE TEXT DEFAULT '';
	DECLARE NEW_VALUE TEXT DEFAULT '';

	IF ((OLD.ET_ID!= NEW.ET_ID) OR (OLD.ETD_EMAIL_SUBJECT!= NEW.ETD_EMAIL_SUBJECT) OR (OLD.ETD_EMAIL_BODY!= NEW.ETD_EMAIL_BODY)) THEN  
	  SET OLD_VALUE = CONCAT(OLD_VALUE,'ETD_ID=', OLD.ETD_ID,','); 
	END IF;

-- get the OLD VALUE & NEW_VALUE for ET_ID to store it in TICKLER_HISTORY table
	IF (OLD.ET_ID!= NEW.ET_ID) THEN 
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ET_ID=', OLD.ET_ID,','); 
	END IF;
	IF (OLD.ET_ID!= NEW.ET_ID) THEN 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'ET_ID=', NEW.ET_ID,','); 
	END IF;

-- get the OLD VALUE & NEW_VALUE for ETD_EMAIL_SUBJECT to store it in TICKLER_HISTORY table
	IF (OLD.ETD_EMAIL_SUBJECT!= NEW.ETD_EMAIL_SUBJECT) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ETD_EMAIL_SUBJECT=', OLD.ETD_EMAIL_SUBJECT,','); 
	END IF;
	IF (OLD.ETD_EMAIL_SUBJECT!= NEW.ETD_EMAIL_SUBJECT) THEN  
		SET NEW_VALUE = CONCAT(NEW_VALUE,'ETD_EMAIL_SUBJECT=', NEW.ETD_EMAIL_SUBJECT,','); 
	END IF;

-- get the OLD VALUE & NEW_VALUE for ETD_EMAIL_BODY to store it in TICKLER_HISTORY table
	IF (OLD.ETD_EMAIL_BODY!= NEW.ETD_EMAIL_BODY) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ETD_EMAIL_BODY=', OLD.ETD_EMAIL_BODY,','); 
	END IF;
	IF (OLD.ETD_EMAIL_BODY!= NEW.ETD_EMAIL_BODY) THEN  
		SET NEW_VALUE = CONCAT(NEW_VALUE,'ETD_EMAIL_BODY=', NEW.ETD_EMAIL_BODY,','); 
	END IF;

	IF ((OLD.ET_ID!= NEW.ET_ID) OR (OLD.ETD_EMAIL_SUBJECT!= NEW.ETD_EMAIL_SUBJECT) OR (OLD.ETD_EMAIL_BODY!= NEW.ETD_EMAIL_BODY)) THEN  
		
		IF (OLD.ULD_ID!= NEW.ULD_ID) THEN  
			SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_ID=', OLD.ULD_ID,','); 
		END IF;

		IF (OLD.ETD_TIMESTAMP!= NEW.ETD_TIMESTAMP) THEN  
			SET OLD_VALUE = CONCAT(OLD_VALUE,'ETD_TIMESTAMP=', OLD.ETD_TIMESTAMP,','); 
		END IF;

	END IF;

-- inserting old_values and new_values in the TICKLER_HISTORY table with their corresponding POSTTAP_ID in TICKLER_TABID_PROFILE
	IF (OLD_VALUE!='' AND NEW_VALUE!='') THEN

		IF(OLD_VALUE != NEW_VALUE)THEN
			
			SET OLD_VALUE = SUBSTRING(OLD_VALUE,1,CHAR_LENGTH(OLD_VALUE)-1);
			SET NEW_VALUE = SUBSTRING(NEW_VALUE,1,CHAR_LENGTH(NEW_VALUE)-1);

			INSERT INTO LMC_TICKLER_HISTORY (TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,TH_USERSTAMP_ID)VALUES
			((SELECT TP_ID FROM LMC_TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
			(SELECT TTIP_ID FROM LMC_TICKLER_TABID_PROFILE WHERE TTIP_DATA='LMC_EMAIL_TEMPLATE_DETAILS'),
			OLD_VALUE,NEW_VALUE,(SELECT ULD_ID FROM LMC_EMAIL_TEMPLATE_DETAILS WHERE ETD_ID=NEW.ETD_ID));

		END IF;

	END IF;

END;
