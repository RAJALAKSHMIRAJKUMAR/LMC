-- VERSION:0.1 --SDATE:18/04/2015 --DESC: LMC_MACHINERY_USAGE TABLE TICKLER TRIGGER --DONE BY:RL


DROP TRIGGER IF EXISTS TRG_LMC_MACHINERY_USAGE_UPDATE;
CREATE TRIGGER TRG_LMC_MACHINERY_USAGE_UPDATE
AFTER UPDATE ON LMC_MACHINERY_USAGE
FOR EACH ROW
BEGIN 

	DECLARE OLD_VALUE TEXT DEFAULT '';
	DECLARE NEW_VALUE TEXT DEFAULT '';

	IF (OLD.MCU_MACHINERY_TYPE!=NEW.MCU_MACHINERY_TYPE) THEN
		SET OLD_VALUE = CONCAT(OLD_VALUE,'MCU_ID=', OLD.MCU_ID,','); 
	END IF;

	IF (OLD.MCU_MACHINERY_TYPE!= NEW.MCU_MACHINERY_TYPE) THEN 
		SET OLD_VALUE = CONCAT(OLD_VALUE,'MCU_MACHINERY_TYPE=', OLD.MCU_MACHINERY_TYPE,',');  
		SET NEW_VALUE = CONCAT(NEW_VALUE,'MCU_MACHINERY_TYPE=', NEW.MCU_MACHINERY_TYPE,','); 
	END IF;

	IF (OLD.MCU_MACHINERY_TYPE!=NEW.MCU_MACHINERY_TYPE) THEN	

		IF (OLD.ULD_ID!= NEW.ULD_ID) THEN  
			SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_ID=', OLD.ULD_ID,','); 
		END IF;

		IF (OLD.MCU_TIMESTAMP!= NEW.MCU_TIMESTAMP) THEN 
			SET OLD_VALUE = CONCAT(OLD_VALUE,'MCU_TIMESTAMP=', OLD.MCU_TIMESTAMP,','); 
		END IF;

	END IF;

	IF (OLD_VALUE!='' AND NEW_VALUE!='') THEN		
			
		IF(OLD_VALUE!=NEW_VALUE)THEN			
				
			SET OLD_VALUE = SUBSTRING(OLD_VALUE,1,CHAR_LENGTH(OLD_VALUE)-1);
			SET NEW_VALUE = SUBSTRING(NEW_VALUE,1,CHAR_LENGTH(NEW_VALUE)-1);			
				
			INSERT INTO LMC_TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,TH_USERSTAMP_ID)VALUES
			((SELECT TP_ID FROM LMC_TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
			(SELECT TTIP_ID FROM LMC_TICKLER_TABID_PROFILE WHERE TTIP_DATA='LMC_MACHINERY_USAGE'),OLD_VALUE,NEW_VALUE,
			(SELECT ULD_ID FROM LMC_MACHINERY_USAGE WHERE MCU_ID=NEW.MCU_ID));
			
		END IF;		
		
	END IF;
	
END;