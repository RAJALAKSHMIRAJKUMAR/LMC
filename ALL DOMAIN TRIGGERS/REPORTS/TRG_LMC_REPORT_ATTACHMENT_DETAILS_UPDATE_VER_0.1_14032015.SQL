-- VERSION:0.1 --SDATE:14/03/2015 --EDATE:14/03/2015 --DESC: LMC_REPORT_ATTACHMENT_DETAILS TABLE TICKLER TRIGGER --DONE BY:RL


DROP TRIGGER IF EXISTS TRG_LMC_REPORT_ATTACHMENT_DETAILS_UPDATE;
CREATE TRIGGER TRG_LMC_REPORT_ATTACHMENT_DETAILS_UPDATE
AFTER UPDATE ON LMC_REPORT_ATTACHMENT_DETAILS
FOR EACH ROW

BEGIN 
	
	DECLARE OLD_VALUE TEXT DEFAULT '';
	DECLARE NEW_VALUE TEXT DEFAULT '';
	
	IF(OLD.RDC_ID!=NEW.RDC_ID) OR(OLD.RAD_DATE!=NEW.RAD_DATE) OR (OLD.RAD_DOC_FILE_NAME!=NEW.RAD_DOC_FILE_NAME) THEN
		SET OLD_VALUE = CONCAT(OLD_VALUE,'RAD_ID=', OLD.RAD_ID,','); 
	END IF;

	IF (OLD.RDC_ID!= NEW.RDC_ID) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'RDC_ID=', OLD.RDC_ID,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'RDC_ID=', NEW.RDC_ID,','); 
	END IF;

	IF (OLD.RAD_DATE!= NEW.RAD_DATE) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'RAD_DATE=', OLD.RAD_DATE,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'RAD_DATE=', NEW.RAD_DATE,','); 
	END IF;

	IF (OLD.RAD_DOC_FILE_NAME!= NEW.RAD_DOC_FILE_NAME) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'RAD_DOC_FILE_NAME=', OLD.RAD_DOC_FILE_NAME,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'RAD_DOC_FILE_NAME=', NEW.RAD_DOC_FILE_NAME,','); 
	END IF;
	
	IF(OLD.RDC_ID!=NEW.RDC_ID) OR(OLD.RAD_DATE!=NEW.RAD_DATE) OR (OLD.RAD_DOC_FILE_NAME!=NEW.RAD_DOC_FILE_NAME) THEN

		IF (OLD.ULD_ID!= NEW.ULD_ID) THEN  
			SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_ID=', OLD.ULD_ID,','); 
		END IF;

		IF (OLD.RAD_TIMESTAMP!= NEW.RAD_TIMESTAMP) THEN 
			SET OLD_VALUE = CONCAT(OLD_VALUE,'RAD_TIMESTAMP=', OLD.RAD_TIMESTAMP,','); 
		END IF;
		
	END IF;

	IF (OLD_VALUE!='' AND NEW_VALUE!='') THEN	

		IF(OLD_VALUE!=NEW_VALUE)THEN	

			SET OLD_VALUE = SUBSTRING(OLD_VALUE,1,CHAR_LENGTH(OLD_VALUE)-1);
			SET NEW_VALUE = SUBSTRING(NEW_VALUE,1,CHAR_LENGTH(NEW_VALUE)-1);

			INSERT INTO LMC_TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,TH_USERSTAMP_ID)VALUES
			((SELECT TP_ID FROM LMC_TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
			(SELECT TTIP_ID FROM LMC_TICKLER_TABID_PROFILE WHERE TTIP_DATA='LMC_REPORT_ATTACHMENT_DETAILS'),
			OLD_VALUE,NEW_VALUE,NEW.ULD_ID);

		END IF;		

	END IF;
	
END;