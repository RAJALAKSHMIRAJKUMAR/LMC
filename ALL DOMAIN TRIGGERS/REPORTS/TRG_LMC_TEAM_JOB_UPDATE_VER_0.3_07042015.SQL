-- VERSION:0.3 --DATE:07/04/2015 --DESC:CHANGED TRIGGER AS PER TABLE DESIGN --DONE BY:RL
-- VERSION:0.2 --DATE:26/03/2015 --DESC:EMP_ID CHANGED AS ULD_ID IN TICKLER HISTORY,LMC_TEAM_REPORT_DETAILS --DONE BY:RL

DROP TRIGGER IF EXISTS TRG_LMC_TEAM_JOB_UPDATE;
CREATE TRIGGER TRG_LMC_TEAM_JOB_UPDATE
AFTER UPDATE ON LMC_TEAM_JOB
FOR EACH ROW

BEGIN 

	DECLARE OLD_VALUE TEXT DEFAULT '';
	DECLARE NEW_VALUE TEXT DEFAULT '';

	IF((OLD.TRD_ID!= NEW.TRD_ID) OR
	(OLD.TJ_PIPE_LAID IS NULL AND NEW.TJ_PIPE_LAID IS NOT NULL) OR
	(OLD.TJ_PIPE_LAID IS NOT NULL AND NEW.TJ_PIPE_LAID IS NULL) OR
	(OLD.TJ_PIPE_LAID!=NEW.TJ_PIPE_LAID) OR
	(OLD.TJ_SIZE IS NULL AND NEW.TJ_SIZE IS NOT NULL) OR
	(OLD.TJ_SIZE IS NOT NULL AND NEW.TJ_SIZE IS NULL) OR
	(OLD.TJ_SIZE!=NEW.TJ_SIZE) OR
	(OLD.TJ_LENGTH IS NULL AND NEW.TJ_LENGTH IS NOT NULL) OR
	(OLD.TJ_LENGTH IS NOT NULL AND NEW.TJ_LENGTH IS NULL) OR
	(OLD.TJ_LENGTH!=NEW.TJ_LENGTH)) THEN
		SET OLD_VALUE = CONCAT(OLD_VALUE,'TJ_ID=', OLD.TJ_ID,','); 
	END IF;

	IF (OLD.TRD_ID!= NEW.TRD_ID) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'TRD_ID=', OLD.TRD_ID,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'TRD_ID=', NEW.TRD_ID,','); 
	END IF;

	IF (OLD.TJ_PIPE_LAID IS NULL AND NEW.TJ_PIPE_LAID IS NOT NULL) THEN
		SET OLD_VALUE=CONCAT(OLD_VALUE,'TJ_PIPE_LAID=','<NULL>,');
		SET NEW_VALUE=CONCAT(NEW_VALUE,'TJ_PIPE_LAID=',NEW.TJ_PIPE_LAID,',');
	ELSEIF(OLD.TJ_PIPE_LAID IS NOT NULL AND NEW.TJ_PIPE_LAID IS NULL) THEN
		SET OLD_VALUE=CONCAT(OLD_VALUE,'TJ_PIPE_LAID=',OLD.TJ_PIPE_LAID,',');
		SET NEW_VALUE=CONCAT(NEW_VALUE,'TJ_PIPE_LAID=','<NULL>,');
	ELSEIF (OLD.TJ_PIPE_LAID!= NEW.TJ_PIPE_LAID) THEN 
		SET OLD_VALUE = CONCAT(OLD_VALUE,'TJ_PIPE_LAID=', OLD.TJ_PIPE_LAID,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'TJ_PIPE_LAID=', NEW.TJ_PIPE_LAID,','); 
	END IF;

	IF (OLD.TJ_SIZE IS NULL AND NEW.TJ_SIZE IS NOT NULL) THEN
		SET OLD_VALUE=CONCAT(OLD_VALUE,'TJ_SIZE=','<NULL>,');
		SET NEW_VALUE=CONCAT(NEW_VALUE,'TJ_SIZE=',NEW.TJ_SIZE,',');
	ELSEIF(OLD.TJ_SIZE IS NOT NULL AND NEW.TJ_SIZE IS NULL) THEN
		SET OLD_VALUE=CONCAT(OLD_VALUE,'TJ_SIZE=',OLD.TJ_SIZE,',');
		SET NEW_VALUE=CONCAT(NEW_VALUE,'TJ_SIZE=','<NULL>,');
	ELSEIF (OLD.TJ_SIZE!= NEW.TJ_SIZE) THEN 
		SET OLD_VALUE = CONCAT(OLD_VALUE,'TJ_SIZE=', OLD.TJ_SIZE,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'TJ_SIZE=', NEW.TJ_SIZE,','); 
	END IF;

	IF (OLD.TJ_LENGTH IS NULL AND NEW.TJ_LENGTH IS NOT NULL) THEN
		SET OLD_VALUE=CONCAT(OLD_VALUE,'TJ_LENGTH=','<NULL>,');
		SET NEW_VALUE=CONCAT(NEW_VALUE,'TJ_LENGTH=',NEW.TJ_LENGTH,',');
	ELSEIF(OLD.TJ_LENGTH IS NOT NULL AND NEW.TJ_LENGTH IS NULL) THEN
		SET OLD_VALUE=CONCAT(OLD_VALUE,'TJ_LENGTH=',OLD.TJ_LENGTH,',');
		SET NEW_VALUE=CONCAT(NEW_VALUE,'TJ_LENGTH=','<NULL>,');
	ELSEIF (OLD.TJ_LENGTH!= NEW.TJ_LENGTH) THEN 
		SET OLD_VALUE = CONCAT(OLD_VALUE,'TJ_LENGTH=', OLD.TJ_LENGTH,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'TJ_LENGTH=', NEW.TJ_LENGTH,','); 
	END IF;

	IF((OLD.TRD_ID!= NEW.TRD_ID) OR
	(OLD.TJ_PIPE_LAID IS NULL AND NEW.TJ_PIPE_LAID IS NOT NULL) OR
	(OLD.TJ_PIPE_LAID IS NOT NULL AND NEW.TJ_PIPE_LAID IS NULL) OR
	(OLD.TJ_PIPE_LAID!=NEW.TJ_PIPE_LAID) OR
	(OLD.TJ_SIZE IS NULL AND NEW.TJ_SIZE IS NOT NULL) OR
	(OLD.TJ_SIZE IS NOT NULL AND NEW.TJ_SIZE IS NULL) OR
	(OLD.TJ_SIZE!=NEW.TJ_SIZE) OR
	(OLD.TJ_LENGTH IS NULL AND NEW.TJ_LENGTH IS NOT NULL) OR
	(OLD.TJ_LENGTH IS NOT NULL AND NEW.TJ_LENGTH IS NULL) OR
	(OLD.TJ_LENGTH!=NEW.TJ_LENGTH)) THEN

		IF (OLD.ULD_ID!= NEW.ULD_ID) THEN  
			SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_ID=', OLD.ULD_ID,','); 
		END IF;

		IF (OLD.TJ_TIMESTAMP!= NEW.TJ_TIMESTAMP) THEN 
			SET OLD_VALUE = CONCAT(OLD_VALUE,'TJ_TIMESTAMP=', OLD.TJ_TIMESTAMP,','); 
		END IF;

	END IF;

	IF (OLD_VALUE!='' AND NEW_VALUE!='') THEN	

		IF(OLD_VALUE!=NEW_VALUE)THEN	

			SET OLD_VALUE = SUBSTRING(OLD_VALUE,1,CHAR_LENGTH(OLD_VALUE)-1);
			SET NEW_VALUE = SUBSTRING(NEW_VALUE,1,CHAR_LENGTH(NEW_VALUE)-1);			
			INSERT INTO LMC_TICKLER_HISTORY(TP_ID,TTIP_ID,ULD_ID,TH_OLD_VALUE,TH_NEW_VALUE,TH_USERSTAMP_ID)VALUES
			((SELECT TP_ID FROM LMC_TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
			(SELECT TTIP_ID FROM LMC_TICKLER_TABID_PROFILE WHERE TTIP_DATA='LMC_TEAM_JOB'),(SELECT ULD_ID FROM LMC_TEAM_REPORT_DETAILS WHERE TRD_ID=NEW.TRD_ID),OLD_VALUE,NEW_VALUE,
			(SELECT ULD_ID FROM LMC_TEAM_JOB WHERE TJ_ID=NEW.TJ_ID));

		END IF;		

	END IF;
	
END;