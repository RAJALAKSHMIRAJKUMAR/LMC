-- VERSION:0.1 --SDATE:21/02/2015 --EDATE:21/02/2015 --ISSUE:2 --COMMENT NO:28 --DESC: TEAM_CREATION TABLE TICKLER TRIGGER --DONE BY:RL


DROP TRIGGER IF EXISTS TRG_LMC_TEAM_CREATION_UPDATE;
CREATE TRIGGER TRG_LMC_TEAM_CREATION_UPDATE
AFTER UPDATE ON LMC_TEAM_CREATION
FOR EACH ROW
BEGIN 

DECLARE OLD_VALUE TEXT DEFAULT '';
DECLARE NEW_VALUE TEXT DEFAULT '';

IF (OLD.TEAM_NAME!=NEW.TEAM_NAME) THEN
	SET OLD_VALUE = CONCAT(OLD_VALUE,'TC_ID=', OLD.TC_ID,','); 
END IF;

IF (OLD.TEAM_NAME!= NEW.TEAM_NAME) THEN 
	SET OLD_VALUE = CONCAT(OLD_VALUE,'TEAM_NAME=', OLD.TEAM_NAME,',');  
	SET NEW_VALUE = CONCAT(NEW_VALUE,'TEAM_NAME=', NEW.TEAM_NAME,','); 
END IF;

IF (OLD.TEAM_NAME!=NEW.TEAM_NAME) THEN	

	IF (OLD.ULD_ID!= NEW.ULD_ID) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_ID=', OLD.ULD_ID,','); 
	END IF;

	IF (OLD.TC_TIMESTAMP!= NEW.TC_TIMESTAMP) THEN 
		SET OLD_VALUE = CONCAT(OLD_VALUE,'TC_TIMESTAMP=', OLD.TC_TIMESTAMP,','); 
	END IF;

END IF;

IF (OLD_VALUE!='' AND NEW_VALUE!='') THEN		
		
	IF(OLD_VALUE!=NEW_VALUE)THEN			
			
		SET OLD_VALUE = SUBSTRING(OLD_VALUE,1,CHAR_LENGTH(OLD_VALUE)-1);
		SET NEW_VALUE = SUBSTRING(NEW_VALUE,1,CHAR_LENGTH(NEW_VALUE)-1);			
			
		INSERT INTO LMC_TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,TH_USERSTAMP_ID)VALUES
		((SELECT TP_ID FROM LMC_TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
		(SELECT TTIP_ID FROM LMC_TICKLER_TABID_PROFILE WHERE TTIP_DATA='LMC_TEAM_CREATION'),OLD_VALUE,NEW_VALUE,
		(SELECT ULD_ID FROM LMC_TEAM_CREATION WHERE TC_ID=NEW.TC_ID));
		
	END IF;		
	
END IF;
END;