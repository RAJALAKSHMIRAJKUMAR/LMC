-- VERSION:0.2 DATE:26/03/2015 DESC: ADDED RC_ID,ULD_WORKER_NAME,ULD_WORKER_NO,ULD_IMAGE_FOLDER_ID,ULD_DOC_FOLDER_ID,ULD_DOC_FILE_NAME --DONE BY:RL
-- VER0.1 STARTDATE:31/01/2015 ENDDATE:31/01/2015 ISSUE:2 COMMENT NO:1 DESC:TICKLER UPDATION TRIGGER FOR USER_LOGIN_DETAILS DONE BY:RL

DROP TRIGGER IF EXISTS TRG_TS_USER_LOGIN_DETAILS_UPDATE;
CREATE TRIGGER TRG_TS_USER_LOGIN_DETAILS_UPDATE  
AFTER UPDATE ON LMC_USER_LOGIN_DETAILS 
FOR EACH ROW

BEGIN 
-- declaration for old_value and new_value to store it in TICKLER_HISTORY table
	DECLARE OLD_VALUE TEXT DEFAULT '';
	DECLARE NEW_VALUE TEXT DEFAULT '';


	IF((OLD.ULD_USERNAME!=NEW.ULD_USERNAME) OR (OLD.ULD_PASSWORD!=NEW.ULD_PASSWORD) OR (OLD.RC_ID!=NEW.RC_ID) 
	OR (OLD.ULD_WORKER_NAME!=NEW.ULD_WORKER_NAME) OR (OLD.ULD_WORKER_NO!=NEW.ULD_WORKER_NO) OR 
	(OLD.ULD_IMAGE_FOLDER_ID!=NEW.ULD_IMAGE_FOLDER_ID) OR (OLD.ULD_DOC_FOLDER_ID!=NEW.ULD_DOC_FOLDER_ID) OR
	(OLD.ULD_DOC_FILE_NAME IS NULL AND NEW.ULD_DOC_FILE_NAME IS NOT NULL) OR 
	(OLD.ULD_DOC_FILE_NAME IS NOT NULL AND NEW.ULD_DOC_FILE_NAME IS NULL) OR (OLD.ULD_DOC_FILE_NAME!=NEW.ULD_DOC_FILE_NAME) OR
	(OLD.ULD_TERMINATE_FLAG IS NULL AND NEW.ULD_TERMINATE_FLAG IS NOT NULL) OR
	(OLD.ULD_TERMINATE_FLAG IS NOT NULL AND NEW.ULD_TERMINATE_FLAG IS NULL) OR
	(OLD.ULD_TERMINATE_FLAG!=NEW.ULD_TERMINATE_FLAG) OR (OLD.ULD_EMAIL_ID!=NEW.ULD_EMAIL_ID) OR
	(OLD.ULD_ADDRESS!=NEW.ULD_ADDRESS) OR (OLD.ULD_NRIC_NO!=NEW.ULD_NRIC_NO) OR (OLD.ULD_MOBILE_NUMBER !=NEW.ULD_MOBILE_NUMBER)) THEN
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_ID=', OLD.ULD_ID,','); 
	END IF;

	IF (OLD.ULD_USERNAME!= NEW.ULD_USERNAME) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_USERNAME=', OLD.ULD_USERNAME,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'ULD_USERNAME=', NEW.ULD_USERNAME,','); 
	END IF;

	IF (OLD.ULD_PASSWORD!= NEW.ULD_PASSWORD) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_PASSWORD=', OLD.ULD_PASSWORD,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'ULD_PASSWORD=', NEW.ULD_PASSWORD,','); 
	END IF;

	IF (OLD.RC_ID!= NEW.RC_ID) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'RC_ID=', OLD.RC_ID,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'RC_ID=', NEW.RC_ID,','); 
	END IF;

	IF (OLD.ULD_WORKER_NAME!= NEW.ULD_WORKER_NAME) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_WORKER_NAME=', OLD.ULD_WORKER_NAME,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'ULD_WORKER_NAME=', NEW.ULD_WORKER_NAME,','); 
	END IF;

	IF (OLD.ULD_WORKER_NO!= NEW.ULD_WORKER_NO) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_WORKER_NO=', OLD.ULD_WORKER_NO,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'ULD_WORKER_NO=', NEW.ULD_WORKER_NO,','); 
	END IF;

	IF (OLD.ULD_IMAGE_FOLDER_ID!= NEW.ULD_IMAGE_FOLDER_ID) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_IMAGE_FOLDER_ID=', OLD.ULD_IMAGE_FOLDER_ID,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'ULD_IMAGE_FOLDER_ID=', NEW.ULD_IMAGE_FOLDER_ID,','); 
	END IF;

	IF (OLD.ULD_DOC_FOLDER_ID!= NEW.ULD_DOC_FOLDER_ID) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_DOC_FOLDER_ID=', OLD.ULD_DOC_FOLDER_ID,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'ULD_DOC_FOLDER_ID=', NEW.ULD_DOC_FOLDER_ID,','); 
	END IF;

	IF (OLD.ULD_DOC_FILE_NAME IS NULL AND NEW.ULD_DOC_FILE_NAME IS NOT NULL) THEN
		SET OLD_VALUE=CONCAT(OLD_VALUE,'ULD_DOC_FILE_NAME=','<NULL>,');
		SET NEW_VALUE=CONCAT(NEW_VALUE,'ULD_DOC_FILE_NAME=',NEW.ULD_DOC_FILE_NAME,',');
	ELSEIF(OLD.ULD_DOC_FILE_NAME IS NOT NULL AND NEW.ULD_DOC_FILE_NAME IS NULL) THEN
		SET OLD_VALUE=CONCAT(OLD_VALUE,'ULD_DOC_FILE_NAME=',OLD.ULD_DOC_FILE_NAME,',');
		SET NEW_VALUE=CONCAT(NEW_VALUE,'ULD_DOC_FILE_NAME=','<NULL>,');
	ELSEIF (OLD.ULD_DOC_FILE_NAME!= NEW.ULD_DOC_FILE_NAME) THEN 
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_DOC_FILE_NAME=', OLD.ULD_DOC_FILE_NAME,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'ULD_DOC_FILE_NAME=', NEW.ULD_DOC_FILE_NAME,','); 
	END IF;

	IF (OLD.ULD_TERMINATE_FLAG IS NULL AND NEW.ULD_TERMINATE_FLAG IS NOT NULL) THEN
		SET OLD_VALUE=CONCAT(OLD_VALUE,'ULD_TERMINATE_FLAG=','<NULL>,');
		SET NEW_VALUE=CONCAT(NEW_VALUE,'ULD_TERMINATE_FLAG=',NEW.ULD_TERMINATE_FLAG,',');
	ELSEIF(OLD.ULD_TERMINATE_FLAG IS NOT NULL AND NEW.ULD_TERMINATE_FLAG IS NULL) THEN
		SET OLD_VALUE=CONCAT(OLD_VALUE,'ULD_TERMINATE_FLAG=',OLD.ULD_TERMINATE_FLAG,',');
		SET NEW_VALUE=CONCAT(NEW_VALUE,'ULD_TERMINATE_FLAG=','<NULL>,');
	ELSEIF (OLD.ULD_TERMINATE_FLAG!= NEW.ULD_TERMINATE_FLAG) THEN 
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_TERMINATE_FLAG=', OLD.ULD_TERMINATE_FLAG,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'ULD_TERMINATE_FLAG=', NEW.ULD_TERMINATE_FLAG,','); 
	END IF;

	IF (OLD.ULD_EMAIL_ID!= NEW.ULD_EMAIL_ID) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_EMAIL_ID=', OLD.ULD_EMAIL_ID,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'ULD_EMAIL_ID=', NEW.ULD_EMAIL_ID,','); 
	END IF;

	IF (OLD.ULD_ADDRESS!= NEW.ULD_ADDRESS) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_ADDRESS=', OLD.ULD_ADDRESS,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'ULD_ADDRESS=', NEW.ULD_ADDRESS,','); 
	END IF;

	IF (OLD.ULD_NRIC_NO!= NEW.ULD_NRIC_NO) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_NRIC_NO=', OLD.ULD_NRIC_NO,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'ULD_NRIC_NO=', NEW.ULD_NRIC_NO,','); 
	END IF;

	IF (OLD.ULD_MOBILE_NUMBER != NEW.ULD_MOBILE_NUMBER ) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_MOBILE_NUMBER =', OLD.ULD_MOBILE_NUMBER ,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'ULD_MOBILE_NUMBER =', NEW.ULD_MOBILE_NUMBER ,','); 
	END IF;

	IF((OLD.ULD_USERNAME!=NEW.ULD_USERNAME) OR (OLD.ULD_PASSWORD!=NEW.ULD_PASSWORD) OR (OLD.RC_ID!=NEW.RC_ID) 
	OR (OLD.ULD_WORKER_NAME!=NEW.ULD_WORKER_NAME) OR (OLD.ULD_WORKER_NO!=NEW.ULD_WORKER_NO) OR 
	(OLD.ULD_IMAGE_FOLDER_ID!=NEW.ULD_IMAGE_FOLDER_ID) OR (OLD.ULD_DOC_FOLDER_ID!=NEW.ULD_DOC_FOLDER_ID) OR
	(OLD.ULD_DOC_FILE_NAME IS NULL AND NEW.ULD_DOC_FILE_NAME IS NOT NULL) OR 
	(OLD.ULD_DOC_FILE_NAME IS NOT NULL AND NEW.ULD_DOC_FILE_NAME IS NULL) OR (OLD.ULD_DOC_FILE_NAME!=NEW.ULD_DOC_FILE_NAME) OR
	(OLD.ULD_TERMINATE_FLAG IS NULL AND NEW.ULD_TERMINATE_FLAG IS NOT NULL) OR
	(OLD.ULD_TERMINATE_FLAG IS NOT NULL AND NEW.ULD_TERMINATE_FLAG IS NULL) OR
	(OLD.ULD_TERMINATE_FLAG!=NEW.ULD_TERMINATE_FLAG) OR (OLD.ULD_EMAIL_ID!=NEW.ULD_EMAIL_ID) OR
	(OLD.ULD_ADDRESS!=NEW.ULD_ADDRESS) OR (OLD.ULD_NRIC_NO!=NEW.ULD_NRIC_NO) OR (OLD.ULD_MOBILE_NUMBER !=NEW.ULD_MOBILE_NUMBER)) THEN

		IF (OLD.ULD_USERSTAMP!= NEW.ULD_USERSTAMP) THEN 
			SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_USERSTAMP=', OLD.ULD_USERSTAMP,','); 
		END IF;

		IF (OLD.ULD_TIMESTAMP!= NEW.ULD_TIMESTAMP) THEN 
			SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_TIMESTAMP=', OLD.ULD_TIMESTAMP,','); 
		END IF;

	END IF;

-- inserting old_values and new_values in the TICKLER_HISTORY table with their corresponding TTIP_ID in TICKLER_TABID_PROFILE
	IF (OLD_VALUE !='' AND NEW_VALUE!='') THEN

		IF (OLD_VALUE != NEW_VALUE)THEN

--  REMOVING COMMA(,) AT THE END OF OLD_VALUE & NEW_VALUE
     		SET OLD_VALUE = SUBSTRING(OLD_VALUE,1,CHAR_LENGTH(OLD_VALUE)-1);
     		SET NEW_VALUE = SUBSTRING(NEW_VALUE,1,CHAR_LENGTH(NEW_VALUE)-1);
	
			INSERT INTO LMC_TICKLER_HISTORY
			(TP_ID,ULD_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,TH_USERSTAMP_ID)VALUES
			((SELECT TP_ID FROM LMC_TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),NEW.ULD_ID,
			(SELECT TTIP_ID FROM LMC_TICKLER_TABID_PROFILE WHERE TTIP_DATA='LMC_USER_LOGIN_DETAILS'),OLD_VALUE,NEW_VALUE,NEW.ULD_USERSTAMP);

		END IF;

	END IF;
	
END;
