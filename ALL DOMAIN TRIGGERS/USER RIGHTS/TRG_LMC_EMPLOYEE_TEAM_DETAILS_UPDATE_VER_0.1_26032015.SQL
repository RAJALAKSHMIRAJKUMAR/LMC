-- VER0.1 STARTDATE:26/03/2015 DESC:TICKLER UPDATION TRIGGER FOR LMC_EMPLOYEE_TEAM_DETAILS DONE BY:RL

DROP TRIGGER IF EXISTS TRG_LMC_EMPLOYEE_TEAM_DETAILS_UPDATE;
CREATE TRIGGER TRG_LMC_EMPLOYEE_TEAM_DETAILS_UPDATE  
AFTER UPDATE ON LMC_EMPLOYEE_TEAM_DETAILS 
FOR EACH ROW

BEGIN 
-- declaration for old_value and new_value to store it in TICKLER_HISTORY table
	DECLARE OLD_VALUE TEXT DEFAULT '';
	DECLARE NEW_VALUE TEXT DEFAULT '';

	IF((OLD.ULD_ID!=NEW.ULD_ID) OR (OLD.TC_ID!=NEW.TC_ID) OR (OLD.WD_ID!=NEW.WD_ID)) THEN
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ETD_ID=', OLD.ETD_ID,','); 
	END IF;

	IF (OLD.ULD_ID!= NEW.ULD_ID) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_ID=', OLD.ULD_ID,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'ULD_ID=', NEW.ULD_ID,','); 
	END IF;

	IF (OLD.TC_ID!= NEW.TC_ID) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'TC_ID=', OLD.TC_ID,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'TC_ID=', NEW.TC_ID,','); 
	END IF;

	IF (OLD.WD_ID!= NEW.WD_ID) THEN  
		SET OLD_VALUE = CONCAT(OLD_VALUE,'WD_ID=', OLD.WD_ID,','); 
		SET NEW_VALUE = CONCAT(NEW_VALUE,'WD_ID=', NEW.WD_ID,','); 
	END IF;

	IF((OLD.ULD_ID!=NEW.ULD_ID) OR (OLD.TC_ID!=NEW.TC_ID) OR (OLD.WD_ID!=NEW.WD_ID)) THEN

		IF (OLD.ETD_USERSTAMP_ID!= NEW.ETD_USERSTAMP_ID) THEN 
			SET OLD_VALUE = CONCAT(OLD_VALUE,'ETD_USERSTAMP_ID=', OLD.ETD_USERSTAMP_ID,','); 
		END IF;

		IF (OLD.ETD_TIMESTAMP!= NEW.ETD_TIMESTAMP) THEN 
			SET OLD_VALUE = CONCAT(OLD_VALUE,'ETD_TIMESTAMP=', OLD.ETD_TIMESTAMP,','); 
		END IF;

	END IF;

-- inserting old_values and new_values in the TICKLER_HISTORY table with their corresponding TTIP_ID in TICKLER_TABID_PROFILE
	IF (OLD_VALUE !='' AND NEW_VALUE!='') THEN

		IF (OLD_VALUE != NEW_VALUE)THEN

--  REMOVING COMMA(,) AT THE END OF OLD_VALUE & NEW_VALUE
     		SET OLD_VALUE = SUBSTRING(OLD_VALUE,1,CHAR_LENGTH(OLD_VALUE)-1);
     		SET NEW_VALUE = SUBSTRING(NEW_VALUE,1,CHAR_LENGTH(NEW_VALUE)-1);
	
			INSERT INTO LMC_TICKLER_HISTORY
			(TP_ID,ULD_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,TH_USERSTAMP_ID)VALUES
			((SELECT TP_ID FROM LMC_TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),NEW.ULD_ID,
			(SELECT TTIP_ID FROM LMC_TICKLER_TABID_PROFILE WHERE TTIP_DATA='LMC_EMPLOYEE_TEAM_DETAILS'),OLD_VALUE,NEW_VALUE,NEW.ETD_USERSTAMP_ID);

		END IF;

	END IF;
	
END;
