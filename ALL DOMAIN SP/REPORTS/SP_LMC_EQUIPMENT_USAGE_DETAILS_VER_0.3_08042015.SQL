-- VERSION:0.3--DATE:07/04/2015 --DESC:CHANGED MANDATORY FIELD AS NON MANDATORY --DONE BY:DHIVYA
-- VERSION:0.2 --DATE:26/03/2015 --DESC:EMP_ID CHANGED AS ULD_ID IN TICKLER HISTORY,LMC_TEAM_REPORT_DETAILS --DONE BY:RL
-- VER0.1 DATE:05/03/2015 ISSUE:2 DESC:SP FOR INSERT,UPDATE & DELETE SP_LMC_EQUIPMENT_USAGE_DETAILS done by:dhivya

DROP PROCEDURE IF EXISTS SP_LMC_EQUIPMENT_USAGE_DETAILS;
CREATE PROCEDURE SP_LMC_EQUIPMENT_USAGE_DETAILS(
IN SEARCH_OPTION INTEGER,
IN EUDID TEXT,
IN TRDID INTEGER,
IN EQUIPMENT TEXT,
IN LORRYNO TEXT,
IN STARTTIME TEXT,
IN ENDTIME TEXT,
IN REMARK TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_MESSAGE TEXT)

BEGIN

	DECLARE EUEQUIPMENT VARCHAR(30);
	DECLARE EULORRYNO VARCHAR(30);
	DECLARE EUSTARTTIME TIME;
	DECLARE EUENDTIME TIME;
	DECLARE EUREMARK TEXT;
	DECLARE T_EUD_ID TEXT;
	DECLARE LMC_EUDID INTEGER;
	DECLARE T_EQUIPMENT VARCHAR(30);
	DECLARE T_LORRYNO VARCHAR(30);
	DECLARE T_START_TIME TIME;
	DECLARE T_END_TIME TIME;
	DECLARE T_REMARK TEXT;
	DECLARE T_ULDID INTEGER;
	DECLARE T_TIMESTAMP TIMESTAMP;
	DECLARE OLDVALUE TEXT;

	SET @EU_EQUIPMENT=EQUIPMENT;
	SET @EU_LORRYNO=LORRYNO;
	SET @EU_STARTTIME=STARTTIME;
	SET @EU_ENDTIME=ENDTIME;
	SET @EU_REMARK=REMARK;
	SET @LMCEUDID=EUDID;

	SET SUCCESS_MESSAGE=0;

	IF SEARCH_OPTION=2 THEN
		
		SET T_EUD_ID=(SELECT REPLACE(EUDID,' ','0'));
		
		SET @SETLMC_EUDID=(SELECT CONCAT('SELECT GROUP_CONCAT(EUD_ID) INTO @L_EUD_ID FROM LMC_EQUIPMENT_USAGE_DETAILS WHERE TRD_ID=',TRDID,' AND EUD_ID NOT IN(',T_EUD_ID,')'));
		PREPARE SETLMC_EUDID_STMT FROM @SETLMC_EUDID;
		EXECUTE SETLMC_EUDID_STMT;

		SET T_EUD_ID= @L_EUD_ID;

		IF T_EUD_ID=' ' THEN
			SET T_EUD_ID=NULL;
		END IF;

		IF T_EUD_ID IS NOT NULL THEN
			SET @TICK_T_EUD_ID=T_EUD_ID;

			MAIN_LOOP : LOOP

				CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TICK_T_EUD_ID,@VALUE,@REMAINING_STRING);
				SELECT @VALUE INTO LMC_EUDID;
				SELECT @REMAINING_STRING INTO @TICK_T_EUD_ID;

				SET T_EQUIPMENT=(SELECT EUD_EQUIPMENT FROM LMC_EQUIPMENT_USAGE_DETAILS WHERE EUD_ID=LMC_EUDID);
				
				IF T_EQUIPMENT IS NULL  THEN
					SET T_EQUIPMENT='<NULL>';
				END IF;

				SET T_LORRYNO=(SELECT EUD_LORRY_NO FROM LMC_EQUIPMENT_USAGE_DETAILS WHERE EUD_ID=LMC_EUDID);
				
				IF T_LORRYNO IS NULL  THEN
					SET T_LORRYNO='<NULL>';
				END IF;
			
				SET T_START_TIME=(SELECT EUD_START_TIME FROM LMC_EQUIPMENT_USAGE_DETAILS WHERE EUD_ID=LMC_EUDID);
				
				IF T_START_TIME IS NULL THEN
					SET T_START_TIME='<NULL>';
				END IF;
				
				SET T_END_TIME=(SELECT EUD_END_TIME FROM  LMC_EQUIPMENT_USAGE_DETAILS WHERE EUD_ID=LMC_EUDID);
				
				IF T_END_TIME IS NULL THEN
					SET T_END_TIME='<NULL>';
				END IF;

				SET T_REMARK=(SELECT EUD_REMARK FROM LMC_EQUIPMENT_USAGE_DETAILS WHERE EUD_ID=LMC_EUDID);
				
				IF T_REMARK IS NULL THEN
					SET T_REMARK='<NULL>';
				END IF;
				
				SET T_ULDID=(SELECT ULD_ID FROM LMC_EQUIPMENT_USAGE_DETAILS WHERE EUD_ID=LMC_EUDID);
				SET T_TIMESTAMP=(SELECT EUD_TIMESTAMP FROM LMC_EQUIPMENT_USAGE_DETAILS WHERE EUD_ID=LMC_EUDID);

				SET OLDVALUE=(SELECT CONCAT('EUD_ID=',LMC_EUDID,',TRD_ID=',TRDID,',EUD_EQUIPMENT=',T_EQUIPMENT,',EUD_LORRY_NO=',T_LORRYNO,',EUD_START_TIME=',T_START_TIME,
				',EUD_END_TIME=',T_END_TIME,',EUD_REMARK=',T_REMARK,',ULD_ID=',T_ULDID,',EUD_TIMESTAMP=',T_TIMESTAMP));

				INSERT INTO LMC_TICKLER_HISTORY(TP_ID,ULD_ID,TTIP_ID,TH_OLD_VALUE,TH_USERSTAMP_ID)VALUES
				((SELECT TP_ID FROM LMC_TICKLER_PROFILE WHERE TP_TYPE='DELETION'),(SELECT ULD_ID FROM LMC_TEAM_REPORT_DETAILS WHERE TRD_ID=TRDID),
				(SELECT TTIP_ID FROM LMC_TICKLER_TABID_PROFILE WHERE TTIP_DATA='LMC_EQUIPMENT_USAGE_DETAILS'),OLDVALUE,
				(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
				
				DELETE FROM LMC_EQUIPMENT_USAGE_DETAILS WHERE  EUD_ID=LMC_EUDID;

				IF @TICK_T_EUD_ID IS NULL THEN
					LEAVE  MAIN_LOOP;
				END IF;
			
			END LOOP;

		END IF;
		
	END IF;

	MAIN_LOOP : LOOP
		
		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@EU_EQUIPMENT,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EUEQUIPMENT;
		SELECT @REMAINING_STRING INTO @EU_EQUIPMENT;

		IF EUEQUIPMENT=' ' THEN
			SET EUEQUIPMENT=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@EU_LORRYNO,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EULORRYNO;
		SELECT @REMAINING_STRING INTO @EU_LORRYNO;
		
		IF EULORRYNO=' ' THEN
			SET EULORRYNO=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@EU_STARTTIME,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EUSTARTTIME;
		SELECT @REMAINING_STRING INTO @EU_STARTTIME;
		
		IF EUSTARTTIME=' ' THEN
			SET EUSTARTTIME=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@EU_ENDTIME,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EUENDTIME;
		SELECT @REMAINING_STRING INTO @EU_ENDTIME;

		IF EUENDTIME=' ' THEN
			SET EUENDTIME=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@EU_REMARK,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EUREMARK;
		SELECT @REMAINING_STRING INTO @EU_REMARK;

		IF EUREMARK='' THEN
			SET EUREMARK=NULL;
		END IF;

		IF SEARCH_OPTION=2 THEN
			CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@LMCEUDID,@VALUE,@REMAINING_STRING);
			SELECT @VALUE INTO LMC_EUDID;
			SELECT @REMAINING_STRING INTO @LMCEUDID;
		END IF;

		IF LMC_EUDID=' ' THEN
			SET LMC_EUDID=NULL;
		END IF; 

		IF SEARCH_OPTION=1 THEN

			IF EUEQUIPMENT IS NOT NULL OR EULORRYNO IS NOT NULL  OR EUSTARTTIME IS NOT NULL OR EUENDTIME IS NOT NULL THEN
				INSERT INTO LMC_EQUIPMENT_USAGE_DETAILS(TRD_ID,EUD_EQUIPMENT,EUD_LORRY_NO,EUD_START_TIME,EUD_END_TIME,EUD_REMARK,ULD_ID)VALUES 
				(TRDID,EUEQUIPMENT,EULORRYNO,EUSTARTTIME,EUENDTIME,EUREMARK,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
			END IF;

		END IF;

		IF SEARCH_OPTION=2 THEN

			IF (LMC_EUDID IS NULL) AND ((EUEQUIPMENT IS NOT NULL OR EULORRYNO IS NOT NULL  OR EUSTARTTIME IS NOT NULL OR EUENDTIME IS NOT NULL)) THEN
				INSERT INTO LMC_EQUIPMENT_USAGE_DETAILS(TRD_ID,EUD_EQUIPMENT,EUD_LORRY_NO,EUD_START_TIME,EUD_END_TIME,EUD_REMARK,ULD_ID)VALUES 
				(TRDID,EUEQUIPMENT,EULORRYNO,EUSTARTTIME,EUENDTIME,EUREMARK,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
			END IF;

			IF (LMC_EUDID IS NOT NULL) AND ((EUEQUIPMENT IS NOT NULL OR EULORRYNO IS NOT NULL  OR EUSTARTTIME IS NOT NULL OR EUENDTIME IS NOT NULL)) THEN
				UPDATE LMC_EQUIPMENT_USAGE_DETAILS SET TRD_ID=TRDID,EUD_EQUIPMENT=EUEQUIPMENT,EUD_LORRY_NO=EULORRYNO,EUD_START_TIME=EUSTARTTIME,EUD_END_TIME=EUENDTIME,
				EUD_REMARK=EUREMARK,ULD_ID=(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP) WHERE EUD_ID=LMC_EUDID;
			END IF;

		END IF;

		IF @EU_EQUIPMENT IS NULL THEN
			LEAVE  MAIN_LOOP;
		END IF;

	END LOOP;
	
	SET SUCCESS_MESSAGE=1;
END;