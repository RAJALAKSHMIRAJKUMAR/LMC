-- VERSION:0.1 --SDATE:16/03/2015 --EDATE:16/03/2015 --DESC: CREATE SP TO SEARCH BY CATEGORY, FILE NAME & DATE RANGE FOR ATTACHMENT DTLS TABLE --DONE BY:RL

DROP PROCEDURE IF EXISTS SP_LMC_TEMP_REPORT_ATTACHMENT_DETAILS_SEARCH;
CREATE PROCEDURE SP_LMC_TEMP_REPORT_ATTACHMENT_DETAILS_SEARCH(
IN OPTION_ID INTEGER,
IN CATEGORY_NAME VARCHAR(50),
IN DOC_FILENAME TEXT,
IN FROM_DATE DATE,
IN TO_DATE DATE,
IN USERSTAMP VARCHAR(50),
OUT FINALTABLENAME TEXT)

BEGIN

	DECLARE USERSTAMP_ID INTEGER;
	DECLARE SYSDATEANDTIME VARCHAR(50);
	DECLARE SYSDATEANDULDID VARCHAR(50);
	DECLARE CATEGORYID INTEGER;

	DECLARE TEMP_ATTACHMENT_DTLS TEXT;
	DECLARE SEARCHOPTION VARCHAR(50);
	DECLARE MIN_ID INTEGER;
	DECLARE MAX_ID INTEGER;

	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
	ROLLBACK;
		IF(TEMP_ATTACHMENT_DTLS IS NOT NULL) THEN
			SET @TEMP_ATTACHMENT_DTLS_DROPQUERY=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_ATTACHMENT_DTLS));
			PREPARE TEMP_ATTACHMENT_DTLS_DROPQUERY_STMT FROM @TEMP_ATTACHMENT_DTLS_DROPQUERY;
			EXECUTE TEMP_ATTACHMENT_DTLS_DROPQUERY_STMT;
		END IF;
	END;
	
	START TRANSACTION;

	IF(CATEGORY_NAME = '') THEN
		SET CATEGORY_NAME = NULL;
	END IF;

	IF(DOC_FILENAME = '') THEN
		SET DOC_FILENAME = NULL;
	END IF;

	IF(FROM_DATE = '') THEN
		SET FROM_DATE = NULL;
	END IF;

	IF(TO_DATE = '') THEN
		SET TO_DATE = NULL;
	END IF;

-- SUB SP FOR CONVERTING USERSTAMP INTO ULDID
	CALL SP_TS_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULD_ID);
	SET USERSTAMP_ID=@ULD_ID;

	SET SYSDATEANDTIME=(SELECT SYSDATE());
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,' ',''));
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,'-',''));
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,':',''));
	SET SYSDATEANDULDID=(SELECT CONCAT(SYSDATEANDTIME,'_',USERSTAMP_ID));

	SET TEMP_ATTACHMENT_DTLS=(SELECT CONCAT('TEMP_ATTACHMENT_DETAILS','_',SYSDATEANDULDID));

	SET @CREATE_TEMP_ATTACHMENT_DTLS_QUERY=(SELECT CONCAT('CREATE TABLE ',TEMP_ATTACHMENT_DTLS,'(
	ID INTEGER NOT NULL AUTO_INCREMENT,
	RADID INTEGER,
	RADCATEGORY VARCHAR(50),
	RADDATE DATE,
	RADDOCFILENAME	TEXT,
	USERSTAMP VARCHAR(50),
	TTIMESTAMP VARCHAR(50),
	PRIMARY KEY(ID))'));
	PREPARE CREATE_TEMP_ATTACHMENT_DTLS_QUERY_STMT FROM @CREATE_TEMP_ATTACHMENT_DTLS_QUERY;
	EXECUTE CREATE_TEMP_ATTACHMENT_DTLS_QUERY_STMT;

	IF(OPTION_ID = 1) THEN 

		SET SEARCHOPTION = 'CATEGORY';

		SET CATEGORYID = (SELECT RDC_ID FROM LMC_REPORT_DOCUMENT_CATEGORY WHERE RDC_CATEGORY = CATEGORY_NAME);
		
		SET @CATEGORY_INSERTQUERY = (SELECT CONCAT('INSERT INTO ',TEMP_ATTACHMENT_DTLS,'
		(RADID,RADCATEGORY,RADDATE,RADDOCFILENAME,USERSTAMP,TTIMESTAMP) 
		SELECT RAD.RAD_ID,RDC.RDC_CATEGORY,RAD.RAD_DATE,RAD.RAD_DOC_FILE_NAME,ULD.ULD_USERNAME,RAD.RAD_TIMESTAMP
		FROM LMC_REPORT_ATTACHMENT_DETAILS RAD, LMC_USER_LOGIN_DETAILS ULD,LMC_REPORT_DOCUMENT_CATEGORY RDC WHERE 
		RDC.RDC_CATEGORY = ','"',CATEGORY_NAME,'"',' AND RAD.ULD_ID=ULD.ULD_ID AND RDC.RDC_ID=RAD.RDC_ID'));
		PREPARE CATEGORY_INSERTQUERY_STMT FROM @CATEGORY_INSERTQUERY;
		EXECUTE CATEGORY_INSERTQUERY_STMT;
	
	END IF;

	IF(OPTION_ID = 2) THEN 

		SET SEARCHOPTION = 'FILENAME';
		
		SET @CATEGORY_INSERTQUERY = (SELECT CONCAT('INSERT INTO ',TEMP_ATTACHMENT_DTLS,'
		(RADID,RADCATEGORY,RADDATE,RADDOCFILENAME,USERSTAMP,TTIMESTAMP) 
		SELECT RAD.RAD_ID,RDC.RDC_CATEGORY,RAD.RAD_DATE,RAD.RAD_DOC_FILE_NAME,ULD.ULD_USERNAME,RAD.RAD_TIMESTAMP
		FROM LMC_REPORT_ATTACHMENT_DETAILS RAD, LMC_USER_LOGIN_DETAILS ULD,LMC_REPORT_DOCUMENT_CATEGORY RDC WHERE 
		((RAD.RAD_DOC_FILE_NAME LIKE ','"','%',DOC_FILENAME,'%','"',') OR (RAD.RAD_DOC_FILE_NAME LIKE ','"','%',DOC_FILENAME,'"','))
		AND RAD.ULD_ID=ULD.ULD_ID AND RDC.RDC_ID=RAD.RDC_ID'));
		PREPARE CATEGORY_INSERTQUERY_STMT FROM @CATEGORY_INSERTQUERY;
		EXECUTE CATEGORY_INSERTQUERY_STMT;
	
	END IF;

	IF(OPTION_ID = 3) THEN 

		SET SEARCHOPTION = 'DATE_RANGE';
		
		SET @CATEGORY_INSERTQUERY = (SELECT CONCAT('INSERT INTO ',TEMP_ATTACHMENT_DTLS,'
		(RADID,RADCATEGORY,RADDATE,RADDOCFILENAME,USERSTAMP,TTIMESTAMP) 
		SELECT RAD.RAD_ID,RDC.RDC_CATEGORY,RAD.RAD_DATE,RAD.RAD_DOC_FILE_NAME,ULD.ULD_USERNAME,RAD.RAD_TIMESTAMP
		FROM LMC_REPORT_ATTACHMENT_DETAILS RAD, LMC_USER_LOGIN_DETAILS ULD,LMC_REPORT_DOCUMENT_CATEGORY RDC WHERE 
		RAD.RAD_DATE >= ','"',FROM_DATE,'"',' AND RAD.RAD_DATE <= ','"',TO_DATE,'"',' AND RAD.ULD_ID=ULD.ULD_ID AND RDC.RDC_ID=RAD.RDC_ID'));
		PREPARE CATEGORY_INSERTQUERY_STMT FROM @CATEGORY_INSERTQUERY;
		EXECUTE CATEGORY_INSERTQUERY_STMT;
	
	END IF;

-- query for create dynamic table name
	SET @TABLENAME=(SELECT CONCAT('TEMP_ATTACHMENT_DETAILS_',SEARCHOPTION ,'_','SEARCH'));
	SET FINALTABLENAME=(SELECT CONCAT(@TABLENAME,'_',SYSDATEANDULDID));

-- query for create table
   SET @CREATEQUERY=(SELECT CONCAT('CREATE TABLE ',FINALTABLENAME,'(
	RAD_ID INTEGER,
	RAD_CATEGORY VARCHAR(50),	
	RAD_DATE DATE,
	RAD_DOC_FILE_NAME TEXT,
	RAD_USERSTAMP VARCHAR(50),
	RAD_TIMESTAMP VARCHAR(50))'));
	PREPARE CREATEQUERYSTMT FROM @CREATEQUERY;
	EXECUTE CREATEQUERYSTMT;
	
	IF((OPTION_ID=1) OR (OPTION_ID=2) OR (OPTION_ID=3))THEN
		
		SET @MINID=(SELECT CONCAT('SELECT MIN(ID) INTO @MINIMUMID FROM ',TEMP_ATTACHMENT_DTLS,''));
		PREPARE MINID_STMT FROM @MINID;
		EXECUTE MINID_STMT;
		
		SET @MAXID=(SELECT CONCAT('SELECT MAX(ID) INTO @MAXIMUMID FROM ',TEMP_ATTACHMENT_DTLS,''));
		PREPARE MAXID_STMT FROM @MAXID;
		EXECUTE MAXID_STMT;
		
		SET MIN_ID = @MINIMUMID;
		SET MAX_ID = @MAXIMUMID;
	
		WHILE (MAX_ID>=MIN_ID)DO
		
			SET @INSERTQUERY = (SELECT CONCAT('INSERT INTO ',FINALTABLENAME,'
			(RAD_ID,RAD_CATEGORY,RAD_DATE,RAD_DOC_FILE_NAME,RAD_USERSTAMP,RAD_TIMESTAMP)
			VALUES ((SELECT RADID FROM ',TEMP_ATTACHMENT_DTLS,' WHERE ID=',MIN_ID,'),
			(SELECT RADCATEGORY FROM ',TEMP_ATTACHMENT_DTLS,' WHERE ID=',MIN_ID,'),
			(SELECT RADDATE FROM ',TEMP_ATTACHMENT_DTLS,' WHERE ID=',MIN_ID,'),
			(SELECT RADDOCFILENAME FROM ',TEMP_ATTACHMENT_DTLS,' WHERE ID=',MIN_ID,'),
			(SELECT USERSTAMP FROM ',TEMP_ATTACHMENT_DTLS,' WHERE ID=',MIN_ID,'),
			(SELECT TTIMESTAMP FROM ',TEMP_ATTACHMENT_DTLS,' WHERE ID=',MIN_ID,'))'));
			PREPARE INSERTQUERYSTMT FROM @INSERTQUERY;
			EXECUTE INSERTQUERYSTMT;
			
		SET MIN_ID = MIN_ID+1;
		END WHILE;
	
	END IF;

	IF(TEMP_ATTACHMENT_DTLS IS NOT NULL) THEN
		SET @TEMP_ATTACHMENT_DTLS_DROPQUERY=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_ATTACHMENT_DTLS));
		PREPARE TEMP_ATTACHMENT_DTLS_DROPQUERY_STMT FROM @TEMP_ATTACHMENT_DTLS_DROPQUERY;
		EXECUTE TEMP_ATTACHMENT_DTLS_DROPQUERY_STMT;
	END IF;

	COMMIT;
	
END;

/*

1. SEARCH BY CATEGORY

CALL SP_LMC_TEMP_REPORT_ATTACHMENT_DETAILS_SEARCH(1,'FORMS',NULL,NULL,NULL,'lmc',@FINALTABLENAME);
select @FINALTABLENAME;

2. SEARCH BY FILE NAME

CALL SP_LMC_TEMP_REPORT_ATTACHMENT_DETAILS_SEARCH(2,NULL,'TEST_1234',NULL,NULL,'lmc',@FINALTABLENAME);
select @FINALTABLENAME;

3. SEACRCH BY DATE RANGE

CALL SP_LMC_TEMP_REPORT_ATTACHMENT_DETAILS_SEARCH(3,NULL,NULL,'2015-03-01','2015-03-31','lmc',@FINALTABLENAME);
select @FINALTABLENAME;

*/