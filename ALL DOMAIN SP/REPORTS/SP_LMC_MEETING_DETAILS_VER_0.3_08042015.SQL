-- VERSION:0.3--DATE:07/04/2015 --DESC:CHANGED MANDATORY FIELD AS NON MANDATORY --DONE BY:DHIVYA
-- VERSION:0.2 --DATE:26/03/2015 --DESC:EMP_ID CHANGED AS ULD_ID IN TICKLER HISTORY,LMC_TEAM_REPORT_DETAILS --DONE BY:RL
-- VER0.1 DATE:05/03/2015 ISSUE:2 DESC:SP FOR INSERT,UPDATE & DELETE LMC_RENTAL_MACHINERY_DETAILS done by:dhivya

DROP PROCEDURE IF EXISTS SP_LMC_MEETING_DETAILS;
CREATE PROCEDURE SP_LMC_MEETING_DETAILS( 
SEARCH_OPTION INTEGER, 
TRDID INTEGER, 
MDID TEXT,
TOPIC TEXT, 
REMARKS TEXT, 
USERSTAMP VARCHAR(50), 
OUT SUCCESS_MESSAGE TEXT) 

BEGIN

	DECLARE LMCTOPIC VARCHAR(50); 
	DECLARE LMCMTID INTEGER;
	DECLARE LMCREMARKS TEXT; 
	DECLARE LMCMDID INTEGER;
	DECLARE T_MTID INTEGER;
	DECLARE T_REMARKS TEXT;
	DECLARE T_ULDID INTEGER;
	DECLARE T_TIMESTAMP TIMESTAMP;
	DECLARE OLDVALUE TEXT;
	DECLARE T_MDID TEXT;

	SET @LMC_MDID=MDID;
	SET @LMC_TOPIC=TOPIC;
	SET @LMC_REMARKS=REMARKS;

	SET SUCCESS_MESSAGE=0;

	IF SEARCH_OPTION=2 THEN

		SET T_MDID=(SELECT REPLACE(MDID,' ','0'));
		SET @SETLMC_MDID=(SELECT CONCAT('SELECT GROUP_CONCAT(MD_ID) INTO @L_MDID FROM LMC_MEETING_DETAILS WHERE TRD_ID=',TRDID,' AND MD_ID 
		NOT IN(',T_MDID,')'));
		PREPARE SETLMC_MDID_STMT FROM @SETLMC_MDID;
		EXECUTE SETLMC_MDID_STMT;

		SET T_MDID= @L_MDID;

		IF T_MDID=' ' THEN
			SET T_MDID=NULL;
		END IF;

		IF T_MDID IS NOT NULL THEN
		
			SET @TICK_T_MDID=T_MDID;

			MAIN_LOOP : LOOP

				CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TICK_T_MDID,@VALUE,@REMAINING_STRING);
				SELECT @VALUE INTO LMCMDID;
				SELECT @REMAINING_STRING INTO @TICK_T_MDID;

				SET T_MTID=(SELECT MT_ID FROM LMC_MEETING_DETAILS WHERE MD_ID=LMCMDID);
			
				IF T_MTID IS NULL  THEN
					SET T_MTID='<NULL>';
				END IF;

				SET T_REMARKS=(SELECT MD_REMARKS FROM LMC_MEETING_DETAILS WHERE MD_ID=LMCMDID);

				IF T_REMARKS IS NULL THEN
					SET T_REMARKS='<NULL>';
				END IF;
			
				SET T_ULDID=(SELECT ULD_ID FROM LMC_MEETING_DETAILS WHERE MD_ID=LMCMDID);
				SET T_TIMESTAMP=(SELECT MD_TIMESTAMP FROM LMC_MEETING_DETAILS WHERE MD_ID=LMCMDID);

				SET OLDVALUE=(SELECT CONCAT('MD_ID=',LMCMDID,',TRD_ID=',TRDID,',MT_ID=',T_MTID,',MD_REMARKS=',T_REMARKS,',ULD_ID=',T_ULDID,',MD_TIMESTAMP=',T_TIMESTAMP));

				INSERT INTO LMC_TICKLER_HISTORY(TP_ID,ULD_ID,TTIP_ID,TH_OLD_VALUE,TH_USERSTAMP_ID)VALUES
				((SELECT TP_ID FROM LMC_TICKLER_PROFILE WHERE TP_TYPE='DELETION'),
				(SELECT ULD_ID FROM LMC_TEAM_REPORT_DETAILS WHERE TRD_ID=TRDID),
				(SELECT TTIP_ID FROM LMC_TICKLER_TABID_PROFILE WHERE TTIP_DATA='LMC_MEETING_DETAILS'),OLDVALUE,
				(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
				DELETE FROM LMC_MEETING_DETAILS WHERE  MD_ID=LMCMDID;

				IF @TICK_T_MDID IS NULL THEN
					LEAVE  MAIN_LOOP;
				END IF;

			END LOOP;

		END IF;

	END IF;

	MAIN_LOOP : LOOP
		
		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@LMC_TOPIC,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO LMCTOPIC;
		SELECT @REMAINING_STRING INTO @LMC_TOPIC;
		
		IF EXISTS(SELECT MT_ID FROM LMC_MEETING_TOPIC WHERE MT_TOPIC=LMCTOPIC)THEN
			SET LMCMTID=(SELECT MT_ID FROM LMC_MEETING_TOPIC WHERE MT_TOPIC=LMCTOPIC);
		ELSE
			INSERT INTO LMC_MEETING_TOPIC(MT_TOPIC,ULD_ID)VALUES(LMCTOPIC,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE 
			ULD_USERNAME=USERSTAMP));
			SET LMCMTID=(SELECT MT_ID FROM LMC_MEETING_TOPIC WHERE MT_TOPIC=LMCTOPIC);
		END IF;

		IF LMCMTID='' THEN
			SET LMCMTID=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@LMC_REMARKS,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO LMCREMARKS;
		SELECT @REMAINING_STRING INTO @LMC_REMARKS;

		IF LMCREMARKS='' THEN
			SET LMCREMARKS=NULL;
		END IF;

		IF SEARCH_OPTION=2 THEN
			CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@LMC_MDID,@VALUE,@REMAINING_STRING);
			SELECT @VALUE INTO LMCMDID;
			SELECT @REMAINING_STRING INTO @LMC_MDID;
		END IF;

		IF LMCMDID=' ' THEN
			SET LMCMDID=NULL;
		END IF; 

		IF SEARCH_OPTION=1 THEN

			IF LMCTOPIC IS NOT NULL THEN
			
				IF NOT EXISTS(SELECT MT_ID FROM LMC_MEETING_DETAILS WHERE TRD_ID=TRDID AND MT_ID=LMCMTID) THEN
					
					INSERT INTO LMC_MEETING_DETAILS(TRD_ID,MT_ID,MD_REMARKS,ULD_ID)VALUES 
					(TRDID,LMCMTID,LMCREMARKS,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
			
				END IF;
		
			END IF;
	
		END IF;

		IF SEARCH_OPTION=2 THEN

			IF LMCMDID IS NULL AND LMCTOPIC IS NOT NULL THEN
			
				IF NOT EXISTS(SELECT MT_ID FROM LMC_MEETING_DETAILS WHERE TRD_ID=TRDID AND MT_ID=LMCMTID) THEN
					
					INSERT INTO LMC_MEETING_DETAILS(TRD_ID,MT_ID,MD_REMARKS,ULD_ID)VALUES 
					(TRDID,LMCMTID,LMCREMARKS,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));	
			
				END IF;
		
			END IF;

			IF LMCMDID IS NOT NULL AND LMCTOPIC IS NOT NULL THEN
			
				UPDATE LMC_MEETING_DETAILS SET TRD_ID=TRDID,MT_ID=LMCMTID,MD_REMARKS=LMCREMARKS,ULD_ID=(SELECT ULD_ID FROM 
				LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP) WHERE MD_ID=LMCMDID;
		
			END IF;
	
		END IF;
		
		IF @LMC_TOPIC IS NULL THEN
			LEAVE  MAIN_LOOP;
		END IF;

	END LOOP;
	
	SET SUCCESS_MESSAGE=1;

END;