DROP PROCEDURE IF EXISTS SP_INSERT_UPDATE_ACCIDENT_DETAILS;
CREATE PROCEDURE SP_INSERT_UPDATE_ACCIDENT_DETAILS(
IN SEARCH_OPTION INTEGER,
IN ARDID INTEGER,
IN ARDDATE DATE,
IN ARDPLACE VARCHAR(50),
IN TYPE_OF_INJURY VARCHAR(50),
IN NATURE_OF_INJURY VARCHAR(50),
IN ARDTIME TIME,
IN LOCATION VARCHAR(50),
IN INJURED_PART VARCHAR(50),
IN MACHINERY_TYPE VARCHAR(50),
IN LM_NO VARCHAR(25),
IN OPERATOR_NAME CHAR(30),
IN NAME CHAR(30),
IN AGE INTEGER,
IN ADDRESS TEXT,
IN NRIC_NO VARCHAR(10),
IN FIN_NO VARCHAR(10),
IN WORK_PERMIT_NO INTEGER,
IN PASSPORT_NO VARCHAR(15),
IN NATIONALITY VARCHAR(30),
IN SEX VARCHAR(6),
IN DOB DATE,
IN MARTIAL_STATUS VARCHAR(10),
IN DESIGNATION VARCHAR(25),
IN LENGTH_OF_SERVICE VARCHAR(50),
IN WORK_COMMENCEMENT VARCHAR(3),
IN DESCRIPTION TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_FLAG TEXT) 

BEGIN

    DECLARE ULDID INTEGER;

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN 
        ROLLBACK;
        SET SUCCESS_FLAG=0;
  	END;

 	START TRANSACTION;

	IF MACHINERY_TYPE='' THEN
		SET MACHINERY_TYPE=null;
	END IF;

	IF LM_NO='' THEN
		SET LM_NO=NULL;
	END IF;

	IF OPERATOR_NAME='' THEN
		SET OPERATOR_NAME=null;
	END IF;

	IF ARDID='' THEN
		SET ARDID=null;
	END IF;

	SET SUCCESS_FLAG=0;
	SET AUTOCOMMIT=0;

	SET ULDID=(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP);

 	IF ARDDATE IS NOT NULL AND ARDPLACE IS NOT NULL AND TYPE_OF_INJURY IS NOT NULL AND NATURE_OF_INJURY 
 	IS NOT NULL AND ARDTIME IS NOT NULL AND LOCATION IS NOT NULL AND INJURED_PART IS NOT NULL AND NAME IS
 	NOT NULL AND AGE IS NOT NULL AND ADDRESS IS NOT NULL AND NRIC_NO IS NOT NULL AND FIN_NO IS NOT NULL 
 	AND WORK_PERMIT_NO IS NOT NULL AND PASSPORT_NO IS NOT NULL AND NATIONALITY IS NOT NULL AND SEX IS 
 	NOT NULL AND DOB IS NOT NULL AND MARTIAL_STATUS IS NOT NULL AND DESIGNATION IS NOT NULL AND 
 	LENGTH_OF_SERVICE IS NOT NULL AND WORK_COMMENCEMENT IS NOT NULL AND DESCRIPTION IS NOT NULL AND 
 	USERSTAMP IS NOT NULL THEN
 		
 		IF SEARCH_OPTION=1 THEN

 		 	INSERT INTO LMC_ACCIDENT_REPORT_DETAILS(ARD_DATE,ARD_PLACE,ARD_TYPE_OF_INJURY,ARD_NATURE_OF_INJURY,
 		 	ARD_TIME,ARD_LOCATION,ARD_INJURED_PART,ARD_MACHINERY_TYPE,ARD_LM_NO,ARD_OPERATOR_NAME,
 		 	ARD_NAME,ARD_AGE,ARD_ADDRESS,ARD_NRIC_NO,ARD_FIN_NO,ARD_WORK_PERMIT_NO,ARD_PASSPORT_NO,
 		 	ARD_NATIONALITY,ARD_SEX,ARD_DOB,ARD_MARTIAL_STATUS,ARD_DESIGNATION,ARD_LENGTH_OF_SERVICE,
 		 	ARD_WORK_COMMENCEMENT,ARD_DESCRIPTION,ULD_ID)VALUES
 		 	(ARDDATE,ARDPLACE,TYPE_OF_INJURY,NATURE_OF_INJURY,ARDTIME,LOCATION,INJURED_PART,MACHINERY_TYPE,
 		 	LM_NO,OPERATOR_NAME,NAME,AGE,ADDRESS,NRIC_NO,FIN_NO,WORK_PERMIT_NO,PASSPORT_NO,NATIONALITY,SEX,
 		 	DOB,MARTIAL_STATUS,DESIGNATION,LENGTH_OF_SERVICE,WORK_COMMENCEMENT,DESCRIPTION,ULDID);
 		 	SET SUCCESS_FLAG=1;

 		 END IF;

 		IF SEARCH_OPTION=2 THEN
 		 	
 		 	UPDATE LMC_ACCIDENT_REPORT_DETAILS SET ARD_DATE=ARDDATE,ARD_PLACE=ARDPLACE,
 		 	ARD_TYPE_OF_INJURY=TYPE_OF_INJURY,ARD_NATURE_OF_INJURY=NATURE_OF_INJURY,ARD_TIME=ARDTIME,
 		 	ARD_LOCATION=LOCATION,ARD_INJURED_PART=INJURED_PART,ARD_MACHINERY_TYPE=MACHINERY_TYPE,
 		 	ARD_LM_NO=LM_NO,ARD_OPERATOR_NAME=OPERATOR_NAME,ARD_NAME=NAME,ARD_AGE=AGE,ARD_ADDRESS=ADDRESS,
 		 	ARD_NRIC_NO=NRIC_NO,ARD_FIN_NO=FIN_NO,ARD_WORK_PERMIT_NO=WORK_PERMIT_NO,
 		 	ARD_PASSPORT_NO=PASSPORT_NO,ARD_NATIONALITY=NATIONALITY,ARD_SEX=SEX,ARD_DOB=DOB,
 		 	ARD_MARTIAL_STATUS=MARTIAL_STATUS,ARD_DESIGNATION=DESIGNATION,ARD_LENGTH_OF_SERVICE=LENGTH_OF_SERVICE,
 		 	ARD_WORK_COMMENCEMENT=WORK_COMMENCEMENT,ARD_DESCRIPTION=DESCRIPTION,ULD_ID=ULDID WHERE ARD_ID=ARDID;
 		 	SET SUCCESS_FLAG=1;

 		 END IF;

 	END IF;

 COMMIT;

 END;