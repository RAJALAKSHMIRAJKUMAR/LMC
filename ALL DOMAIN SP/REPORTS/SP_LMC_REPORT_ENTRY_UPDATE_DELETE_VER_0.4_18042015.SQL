--VERSION:0.4 --DATE:18/04/2015 --DESC:TRD_CONTRACT_NO CHANGED AS CLD_ID IN LMC_TEAM_REPORT_DETAILS TABLE --DONE BY:RL
-- VERSION:0.3--DATE:07/04/2015 --DESC:CHANGED MANDATORY FIELD AS NON MANDATORY --DONE BY:DHIVYA
-- VERSION:0.2 --SDATE:17/03/2015 --EDATE:17/03/2015 --DESC:MERGERED MANDATORY FIELDS VALIDATIONS FOR LMC_TEAM_REPORT_DETAILS,LMC_TEAM_EMPLOYEE_REPORT_DETAILS,LMC_TEAM_JOB TABLE -- DONE BY:RL
-- VER0.1 DATE:05/03/2015 ISSUE:2 DESC:SP FOR INSERT,UPDATE & DELETE ALL TABLES IN PERMIT DOMAIN done by:dhivya


DROP PROCEDURE IF EXISTS SP_LMC_REPORT_ENTRY_UPDATE_DELETE;
CREATE PROCEDURE SP_LMC_REPORT_ENTRY_UPDATE_DELETE(
IN SEARCH_OPTION INTEGER,
IN TEAMNAME VARCHAR(25),
IN EMPID INTEGER,
IN REPORTDATE DATE,
IN LOCATION TEXT,
IN CONTRACTNO VARCHAR(10),
IN REACH_SITE TIME,
IN LEAVE_SITE TIME,
IN TYPE_OF_JOB VARCHAR(50),
IN WEATHER_REASON VARCHAR(30),
IN WEATHER_FROM_TIME TIME,
IN WEATHER_TO_TIME TIME,
IN PIPE_TESTING VARCHAR(50),
IN START_PRESSURE TEXT,
IN END_PRESSURE TEXT,
IN TEAM_REMARK TEXT,
IN IMGFILENAME TEXT,
IN PIPE_LAID TEXT,
IN TJSIZE TEXT,
IN TJLENGTH TEXT,
IN EMP_START_TIME TEXT,
IN EMP_END_TIME TEXT,
IN EMP_OT TEXT,
IN EMP_REMARK TEXT,
IN SVDID TEXT,
IN SITE_VISIT_NAME TEXT,
IN SITE_VISIT_DESIG TEXT,
IN SITE_START_TIME TEXT,
IN SITE_END_TIME TEXT,
IN SITE_REMARK TEXT,
IN METID TEXT,
IN METFROMLORRYNO TEXT,
IN METTOLORRYNO TEXT,
IN METITEM TEXT,
IN METREMARK TEXT,
IN MACID TEXT,
IN MACHINERY_TYPE TEXT,
IN MACSTARTTIME TEXT,
IN MACENDTIME TEXT,
IN MACREMARK TEXT,
IN FUDID TEXT,
IN FUDITEMS TEXT,
IN FUDSIZE TEXT,
IN FUDQUANTITY TEXT,
IN FUDREMARK TEXT,
IN MUDID TEXT,
IN MUDITEMS TEXT,
IN MUDRECEIPTNO TEXT,
IN MUDQUANTITY TEXT,
IN RMDID TEXT,
IN RMDLORRYNO TEXT,
IN RMD_EARTHSTORE TEXT,
IN RMD_EARTHOUTSIDE TEXT,
IN RMDSTARTTIME TEXT,
IN RMDENDTIME TEXT,
IN RMDREMARK TEXT,
IN EUDID TEXT,
IN EUDEQUIPMENT TEXT,
IN EUDLORRYNO TEXT,
IN EUDSTARTTIME TEXT,
IN EUDENDTIME TEXT,
IN EUDREMARK TEXT,
IN MDID TEXT,
IN MDTOPIC TEXT,
IN MDREMARKS TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_MESSAGE TEXT)

BEGIN

	DECLARE TRDID INTEGER;
	DECLARE ERROR_MSG TEXT;
	DECLARE REPORTCOUNT INTEGER;
	DECLARE OLDDATE DATE;

	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
	ROLLBACK;
		IF SUCCESS_MESSAGE=' ' THEN
		SET SUCCESS_MESSAGE=0;
		END IF;
	END;

	START TRANSACTION;
	SET AUTOCOMMIT=0;
	SET SUCCESS_MESSAGE=' ';

	IF SEARCH_OPTION=1 THEN
		
		SET REPORTCOUNT=(SELECT COUNT(*) FROM LMC_TEAM_REPORT_DETAILS WHERE TRD_DATE=REPORTDATE AND TC_ID=(SELECT TC_ID FROM LMC_TEAM_CREATION WHERE TEAM_NAME=TEAMNAME) AND ULD_ID=EMPID);

		IF REPORTCOUNT>0 THEN
			SET @CHECKFLAG=1;
			SET ERROR_MSG=(SELECT EMC_DATA FROM LMC_ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID = 6);
		    SET ERROR_MSG=(SELECT REPLACE(ERROR_MSG,'[DATE]',REPORTDATE));
			SET SUCCESS_MESSAGE=(SELECT CONCAT(SUCCESS_MESSAGE,ERROR_MSG));
		END IF;

	END IF;

-- LMC_TEAM_JOB

	IF PIPE_LAID='' THEN
		SET PIPE_LAID=NULL;
	END IF;

	IF TJSIZE='' THEN
		SET TJSIZE=NULL;
	END IF;

	IF TJLENGTH='' THEN
		SET TJLENGTH=NULL;
	END IF;

-- LMC_TEAM_EMPLOYEE_REPORT_DETAILS

	IF EMPID='' THEN
		SET EMPID=NULL;
	END IF;

	IF EMP_START_TIME='' THEN
		SET EMP_START_TIME=NULL;
	END IF;

	IF EMP_END_TIME='' THEN
		SET EMP_END_TIME=NULL;
	END IF;

	IF EMP_OT='' THEN
		SET EMP_OT=NULL;
	END IF;

	IF EMP_REMARK='' THEN
		SET EMP_REMARK=NULL;
	END IF;

-- LMC_MEETING_DETAILS

	IF MDTOPIC='' THEN
		SET MDTOPIC=NULL;
	END IF;

	IF MDREMARKS='' THEN
		SET MDREMARKS=NULL;
	END IF;

-- LMC_SITE_VISIT_DETAILS

	IF SITE_VISIT_NAME='' THEN
		SET SITE_VISIT_NAME=NULL;
	END IF;

	IF SITE_VISIT_DESIG='' THEN
		SET SITE_VISIT_DESIG=NULL;
	END IF;

	IF SITE_START_TIME='' THEN
		SET SITE_START_TIME=NULL;
	END IF;

	IF SITE_END_TIME='' THEN
		SET SITE_END_TIME=NULL;
	END IF;

-- LMC_MACHINERY_EQUIPMENT_TRANSFER

	IF METFROMLORRYNO='' THEN
		SET METFROMLORRYNO=NULL;
	END IF;

	IF METTOLORRYNO='' THEN
		SET METTOLORRYNO=NULL;
	END IF;

	IF METITEM='' THEN
		SET METITEM=NULL;
	END IF;

-- LMC_MACHINERY_USAGE_DETAILS

	IF MACHINERY_TYPE='' THEN
		SET MACHINERY_TYPE=NULL;
	END IF;

	IF MACSTARTTIME='' THEN
		SET MACSTARTTIME=NULL;
	END IF;

	IF MACENDTIME=' ' THEN
		SET MACENDTIME=NULL;
	END IF;

-- LMC_FITTING_USAGE_DETAILS

	IF FUDITEMS='' THEN
		SET FUDITEMS=NULL;
	END IF;

	IF FUDSIZE='' THEN
		SET FUDSIZE=NULL;
	END IF;

	IF FUDQUANTITY='' THEN
		SET FUDQUANTITY=NULL;
	END IF;

-- LMC_MATERIAL_USAGE_DETAILS

	IF MUDITEMS='' THEN
		SET MUDITEMS=NULL;
	END IF;

	IF MUDRECEIPTNO='' THEN
		SET MUDRECEIPTNO=NULL;
	END IF;

	IF MUDQUANTITY='' THEN
		SET MUDQUANTITY=NULL;
	END IF;

-- LMC_RENTAL_MACHINERY_DETAILS

	IF RMDLORRYNO=' ' THEN
		SET RMDLORRYNO=NULL;
	END IF;

	IF RMD_EARTHSTORE='' THEN
		SET RMD_EARTHSTORE=NULL;
	END IF;

	IF RMD_EARTHOUTSIDE='' THEN
		SET RMD_EARTHOUTSIDE=NULL;
	END IF;

	IF RMDSTARTTIME='' THEN
		SET RMDSTARTTIME=NULL;
	END IF;

	IF RMDENDTIME='' THEN
		SET RMDENDTIME=NULL;
	END IF;

-- LMC_EQUIPMENT_USAGE_DETAILS

	IF EUDEQUIPMENT='' THEN
		SET EUDEQUIPMENT=NULL;
	END IF;

	IF EUDLORRYNO=' ' THEN
		SET EUDLORRYNO=NULL;
	END IF;

	IF EUDSTARTTIME=' ' THEN
		SET EUDSTARTTIME=NULL;
	END IF;

	IF EUDENDTIME=' ' THEN
		SET EUDENDTIME=NULL;
	END IF;

	IF SUCCESS_MESSAGE=' ' THEN

	-- LMC_TEAM_REPORT_DETAILS

		IF EMPID IS NOT NULL AND TEAMNAME IS NOT NULL AND REPORTDATE IS NOT NULL AND USERSTAMP IS NOT NULL THEN

			IF SEARCH_OPTION=1 THEN

				INSERT INTO LMC_TEAM_REPORT_DETAILS(ULD_ID,TRD_DATE,TRD_LOCATION,TRD_CONTRACT_NO,TC_ID,
				TRD_REACH_SITE,TRD_LEAVE_SITE,TOJ_ID,TRD_WEATHER_REASON,TRD_WEATHER_FROM_TIME,TRD_WEATHER_TO_TIME,
				TRD_PIPE_TESTING,TRD_START_PRESSURE,TRD_END_PRESSURE,TRD_REMARK,TRD_IMG_FILE_NAME,TRD_USERSTAMP_ID)VALUES
				(EMPID,REPORTDATE,LOCATION,CONTRACTNO,(SELECT TC_ID FROM LMC_TEAM_CREATION WHERE TEAM_NAME=TEAMNAME),
				REACH_SITE,LEAVE_SITE,TYPE_OF_JOB,WEATHER_REASON,WEATHER_FROM_TIME,WEATHER_TO_TIME,PIPE_TESTING,START_PRESSURE,
				END_PRESSURE,TEAM_REMARK,IMGFILENAME,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
				SET TRDID=(SELECT TRD_ID FROM LMC_TEAM_REPORT_DETAILS ORDER BY TRD_ID DESC LIMIT 1);

			END IF;
		
			IF SEARCH_OPTION=2 THEN

				UPDATE LMC_TEAM_REPORT_DETAILS SET ULD_ID=EMPID,TRD_DATE=REPORTDATE,TRD_LOCATION=LOCATION,
				TRD_CONTRACT_NO=CONTRACTNO,TC_ID=(SELECT TC_ID FROM LMC_TEAM_CREATION WHERE TEAM_NAME=TEAMNAME),
				TRD_REACH_SITE=REACH_SITE,TRD_LEAVE_SITE=LEAVE_SITE,TOJ_ID=TYPE_OF_JOB,TRD_WEATHER_REASON=WEATHER_REASON,
				TRD_WEATHER_FROM_TIME= WEATHER_FROM_TIME,TRD_WEATHER_TO_TIME=WEATHER_TO_TIME,TRD_PIPE_TESTING=PIPE_TESTING,
				TRD_START_PRESSURE=START_PRESSURE,TRD_END_PRESSURE=END_PRESSURE,TRD_REMARK=TEAM_REMARK,TRD_IMG_FILE_NAME=IMGFILENAME,
				TRD_USERSTAMP_ID=(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP) WHERE ULD_ID=EMPID AND TRD_DATE=REPORTDATE;
		
			END IF;
		END IF;

			SET TRDID=(SELECT TRD_ID FROM LMC_TEAM_REPORT_DETAILS WHERE ULD_ID=EMPID AND TRD_DATE=REPORTDATE);

-- LMC_TEAM_JOB
		IF PIPE_LAID IS NOT NULL OR TJSIZE IS NOT NULL OR TJLENGTH IS NOT NULL THEN

			CALL SP_LMC_TEAM_JOB(SEARCH_OPTION,TRDID,PIPE_LAID,TJSIZE,TJLENGTH,USERSTAMP,@SUCCESS_MESSAGE);
		END IF;

-- LMC_TEAM_EMPLOYEE_REPORT_DETAILS
IF EMPID IS NOT NULL  THEN
		

			IF SEARCH_OPTION=1 THEN

				IF NOT EXISTS(SELECT TRD_ID FROM LMC_TEAM_EMPLOYEE_REPORT_DETAILS WHERE TRD_ID=TRDID) THEN
					
					INSERT INTO LMC_TEAM_EMPLOYEE_REPORT_DETAILS(TRD_ID,ULD_ID,TERD_START_TIME,TERD_END_TIME,TERD_OT,TERD_REMARK,TERD_USERSTAMP_ID)VALUES 
					(TRDID,EMPID,EMP_START_TIME,EMP_END_TIME,EMP_OT,EMP_REMARK,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
				
				END IF;

			END IF;

			IF SEARCH_OPTION=2 THEN

				UPDATE LMC_TEAM_EMPLOYEE_REPORT_DETAILS SET TRD_ID=TRDID,ULD_ID=EMPID,TERD_START_TIME=EMP_START_TIME,TERD_END_TIME=EMP_END_TIME,
				TERD_OT=EMP_OT,TERD_REMARK=EMP_REMARK,TERD_USERSTAMP_ID=(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP) WHERE ULD_ID=EMPID AND TRD_ID=TRDID;
			
			END IF;
END IF;

-- LMC_MEETING_DETAILS

			IF MDTOPIC IS NOT NULL THEN
				CALL SP_LMC_MEETING_DETAILS(SEARCH_OPTION,TRDID,MDID,MDTOPIC,MDREMARKS,USERSTAMP,@SUCCESS_MESSAGE);
			END IF;

-- LMC_SITE_VISIT_DETAILS

			IF SITE_VISIT_NAME IS NOT NULL OR SITE_VISIT_DESIG IS NOT NULL OR SITE_START_TIME IS NOT NULL OR SITE_END_TIME IS NOT NULL THEN
				CALL SP_LMC_SITE_VISIT_DETAILS(SEARCH_OPTION,TRDID,SVDID,SITE_VISIT_NAME,SITE_VISIT_DESIG,SITE_START_TIME,SITE_END_TIME,SITE_REMARK,USERSTAMP,@SUCCESS_MESSAGE);
			END IF;

-- LMC_MACHINERY_EQUIPMENT_TRANSFER

			IF METFROMLORRYNO IS NOT NULL OR METTOLORRYNO IS NOT NULL OR METITEM IS NOT NULL THEN
				CALL SP_LMC_MACHINERY_EQUIPMENT_TRANSFER(SEARCH_OPTION,METID,TRDID,METFROMLORRYNO,METTOLORRYNO,METITEM,METREMARK,USERSTAMP,@SUCCESS_MESSAGE);
			END IF;

-- LMC_MACHINERY_USAGE_DETAILS

			IF MACHINERY_TYPE IS NOT NULL THEN
				CALL SP_LMC_MACHINERY_USAGE_DETAILS(SEARCH_OPTION,MACID,TRDID,MACHINERY_TYPE,MACSTARTTIME,MACENDTIME,MACREMARK,USERSTAMP,@SUCCESS_MESSAGE);
			END IF;

-- LMC_FITTING_USAGE_DETAILS

			IF FUDITEMS IS NOT NULL THEN
				CALL SP_LMC_FITTING_USAGE_DETAILS(SEARCH_OPTION,FUDID,TRDID,FUDITEMS,FUDSIZE,FUDQUANTITY,FUDREMARK,USERSTAMP,@SUCCESS_MESSAGE);
			END IF;

-- LMC_MATERIAL_USAGE_DETAILS

			IF MUDITEMS IS NOT NULL THEN
				CALL SP_LMC_MATERAIL_USAGE_DETAILS(SEARCH_OPTION,MUDID,TRDID,MUDITEMS,MUDRECEIPTNO,MUDQUANTITY,USERSTAMP,@SUCCESS_MESSAGE);
			END IF;
	
-- LMC_RENTAL_MACHINERY_DETAILS

			IF RMDLORRYNO IS NOT NULL OR RMD_EARTHSTORE IS NOT NULL OR RMD_EARTHOUTSIDE IS NOT NULL OR RMDSTARTTIME IS NOT NULL OR RMDENDTIME IS NOT NULL THEN
				CALL SP_LMC_RENTAL_MACHINERY_DETAILS(SEARCH_OPTION,RMDID,TRDID,RMDLORRYNO,RMD_EARTHSTORE,RMD_EARTHOUTSIDE,RMDSTARTTIME,RMDENDTIME,RMDREMARK,USERSTAMP,@SUCCESS_MESSAGE);
			END IF;

-- LMC_EQUIPMENT_USAGE_DETAILS

			IF EUDEQUIPMENT IS NOT NULL OR EUDLORRYNO IS NOT NULL OR EUDSTARTTIME IS NOT NULL OR EUDENDTIME IS NOT NULL THEN
				CALL SP_LMC_EQUIPMENT_USAGE_DETAILS(SEARCH_OPTION,EUDID,TRDID,EUDEQUIPMENT,EUDLORRYNO,EUDSTARTTIME,EUDENDTIME,EUDREMARK,USERSTAMP,@SUCCESS_MESSAGE);
			END IF;

			SET SUCCESS_MESSAGE=1;

		END IF;

	COMMIT;

END;