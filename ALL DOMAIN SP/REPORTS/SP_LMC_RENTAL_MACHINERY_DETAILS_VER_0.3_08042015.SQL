-- VERSION:0.3--DATE:07/04/2015 --DESC:CHANGED MANDATORY FIELD AS NON MANDATORY --DONE BY:DHIVYA
-- VERSION:0.2 --DATE:26/03/2015 --DESC:EMP_ID CHANGED AS ULD_ID IN TICKLER HISTORY,LMC_TEAM_REPORT_DETAILS --DONE BY:RL
-- VER0.1 DATE:05/03/2015 ISSUE:2 DESC:SP FOR INSERT,UPDATE & DELETE LMC_RENTAL_MACHINERY_DETAILS done by:dhivya

DROP PROCEDURE IF EXISTS SP_LMC_RENTAL_MACHINERY_DETAILS;
CREATE PROCEDURE SP_LMC_RENTAL_MACHINERY_DETAILS( 
IN SEARCH_OPTION INTEGER, 
IN RMDID TEXT, 
IN TRDID INTEGER, 
IN LORRYNO TEXT, 
IN THROW_EARTH_STORE TEXT, 
IN THROW_EARTH_OUTSIDE TEXT,
IN STARTTIME TEXT, 
IN ENDTIME TEXT, 
IN REMARK TEXT, 
IN USERSTAMP VARCHAR(50), 
OUT SUCCESS_MESSAGE TEXT) 

BEGIN 

	DECLARE RMLORRYNO VARCHAR(20); 
	DECLARE RMTHROW_EARTH_STORE INTEGER; 
	DECLARE RMTHROW_EARTH_OUTSIDE INTEGER; 
	DECLARE RMSTARTTIME TIME; 
	DECLARE RMENDTIME TIME; 
	DECLARE RMREMARK TEXT; 
	DECLARE T_RMD_ID TEXT; 
	DECLARE LMC_RMDID INTEGER; 
	DECLARE T_LORRYNO VARCHAR(20);
	DECLARE T_EARTH_STORE INTEGER;
	DECLARE T_EARTH_OUTSIDE INTEGER;
	DECLARE T_START_TIME TIME;
	DECLARE T_END_TIME TIME;
	DECLARE T_REMARK TEXT;
	DECLARE T_ULDID INTEGER;
	DECLARE T_TIMESTAMP TIMESTAMP;
	DECLARE OLDVALUE TEXT;

	SET @RM_LORRYNO=LORRYNO;
	SET @RM_THROW_EARTH_STORE=THROW_EARTH_STORE;
	SET @RM_THROW_EARTH_OUTSIDE=THROW_EARTH_OUTSIDE;
	SET @RM_STARTTIME=STARTTIME;
	SET @RM_ENDTIME=ENDTIME;
	SET @RM_REMARK=REMARK;
	SET @LMCRMDID=RMDID;

	SET SUCCESS_MESSAGE=0;

	IF SEARCH_OPTION=2 THEN
		
		SET T_RMD_ID=(SELECT REPLACE(RMDID,' ','0'));

		SET @SETLMC_RMD_ID=(SELECT CONCAT('SELECT GROUP_CONCAT(RMD_ID) INTO @L_RMDID FROM LMC_RENTAL_MACHINERY_DETAILS WHERE TRD_ID=',TRDID,' AND RMD_ID NOT IN(',T_RMD_ID,')'));
		PREPARE SETLMC_RMD_ID_STMT FROM @SETLMC_RMD_ID;
		EXECUTE SETLMC_RMD_ID_STMT;

		SET T_RMD_ID= @L_RMDID;

		IF T_RMD_ID=' ' THEN
			SET T_RMD_ID=NULL;
		END IF;

		IF T_RMD_ID IS NOT NULL THEN
			SET @TICK_T_RMDID=T_RMD_ID;

			MAIN_LOOP : LOOP

				CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TICK_T_RMDID,@VALUE,@REMAINING_STRING);
				SELECT @VALUE INTO LMC_RMDID;
				SELECT @REMAINING_STRING INTO @TICK_T_RMDID;

				SET T_LORRYNO=(SELECT RMD_LORRY_NO FROM LMC_RENTAL_MACHINERY_DETAILS WHERE RMD_ID=LMC_RMDID);
				
				IF T_LORRYNO IS NULL  THEN
					SET T_LORRYNO='<NULL>';
				END IF;
				
				SET T_EARTH_STORE=(SELECT RMD_THROWEARTH_STORE FROM LMC_RENTAL_MACHINERY_DETAILS WHERE RMD_ID=LMC_RMDID);
				
				IF T_EARTH_STORE IS NULL THEN
					SET T_EARTH_STORE='<NULL>';
				END IF;
				
				SET T_EARTH_OUTSIDE=(SELECT RMD_THROWEARTH_OUTSIDE FROM LMC_RENTAL_MACHINERY_DETAILS WHERE RMD_ID=LMC_RMDID);
				
				IF T_EARTH_OUTSIDE IS NULL THEN
					SET T_EARTH_OUTSIDE='<NULL>';
				END IF;
				
				SET T_START_TIME=(SELECT RMD_START_TIME FROM LMC_RENTAL_MACHINERY_DETAILS WHERE RMD_ID=LMC_RMDID);
				
				IF T_START_TIME IS NULL THEN
					SET T_START_TIME='<NULL>';
				END IF;
				
				SET T_END_TIME=(SELECT RMD_END_TIME FROM LMC_RENTAL_MACHINERY_DETAILS WHERE RMD_ID=LMC_RMDID);
				
				IF T_END_TIME IS NULL THEN
					SET T_END_TIME='<NULL>';
				END IF;

				SET T_REMARK=(SELECT RMD_REMARK FROM LMC_RENTAL_MACHINERY_DETAILS WHERE RMD_ID=LMC_RMDID);
				
				IF T_REMARK IS NULL THEN
					SET T_REMARK='<NULL>';
				END IF;
				
				SET T_ULDID=(SELECT ULD_ID FROM LMC_RENTAL_MACHINERY_DETAILS WHERE RMD_ID=LMC_RMDID);
				SET T_TIMESTAMP=(SELECT RMD_TIMESTAMP FROM LMC_RENTAL_MACHINERY_DETAILS WHERE RMD_ID=LMC_RMDID);

				SET OLDVALUE=(SELECT CONCAT('RMD_ID=',LMC_RMDID,',TRD_ID=',TRDID,',RMD_LORRY_NO=',T_LORRYNO,',RMD_THROWEARTH_STORE=',T_EARTH_STORE,',RMD_THROWEARTH_OUTSIDE=',T_EARTH_OUTSIDE,
				',RMD_START_TIME=',T_START_TIME,',RMD_END_TIME=',T_END_TIME,',RMD_REMARK=',T_REMARK,',ULD_ID=',T_ULDID,',RMD_TIMESTAMP=',T_TIMESTAMP));

				INSERT INTO LMC_TICKLER_HISTORY(TP_ID,ULD_ID,TTIP_ID,TH_OLD_VALUE,TH_USERSTAMP_ID)VALUES
				((SELECT TP_ID FROM LMC_TICKLER_PROFILE WHERE TP_TYPE='DELETION'),(SELECT ULD_ID FROM LMC_TEAM_REPORT_DETAILS WHERE TRD_ID=TRDID),
				(SELECT TTIP_ID FROM LMC_TICKLER_TABID_PROFILE WHERE TTIP_DATA='LMC_RENTAL_MACHINERY_DETAILS'),OLDVALUE,
				(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
				DELETE FROM LMC_RENTAL_MACHINERY_DETAILS WHERE  RMD_ID=LMC_RMDID;

				IF @TICK_T_RMDID IS NULL THEN
					LEAVE  MAIN_LOOP;
				END IF;

			END LOOP;

		END IF;

	END IF;

	MAIN_LOOP : LOOP
		
		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@RM_LORRYNO,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO RMLORRYNO;
		SELECT @REMAINING_STRING INTO @RM_LORRYNO;

		IF RMLORRYNO='' THEN
			SET RMLORRYNO=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@RM_THROW_EARTH_STORE,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO RMTHROW_EARTH_STORE;
		SELECT @REMAINING_STRING INTO @RM_THROW_EARTH_STORE;

		IF RMTHROW_EARTH_STORE='' THEN
			SET RMTHROW_EARTH_STORE=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@RM_THROW_EARTH_OUTSIDE,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO RMTHROW_EARTH_OUTSIDE;
		SELECT @REMAINING_STRING INTO @RM_THROW_EARTH_OUTSIDE;

		IF RMTHROW_EARTH_OUTSIDE='' THEN
			SET RMTHROW_EARTH_OUTSIDE=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@RM_STARTTIME,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO RMSTARTTIME;
		SELECT @REMAINING_STRING INTO @RM_STARTTIME;

		IF RMSTARTTIME='' THEN
			SET RMSTARTTIME=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@RM_ENDTIME,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO RMENDTIME;
		SELECT @REMAINING_STRING INTO @RM_ENDTIME;

		IF RMENDTIME='' THEN
			SET RMENDTIME=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@RM_REMARK,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO RMREMARK;
		SELECT @REMAINING_STRING INTO @RM_REMARK;

		IF RMREMARK='' THEN
			SET RMREMARK=NULL;
		END IF;

		IF SEARCH_OPTION=2 THEN
			CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@LMCRMDID,@VALUE,@REMAINING_STRING);
			SELECT @VALUE INTO LMC_RMDID;
			SELECT @REMAINING_STRING INTO @LMCRMDID;
		END IF;

		IF LMC_RMDID=' ' THEN
			SET LMC_RMDID=NULL;
		END IF; 

		IF SEARCH_OPTION=1 THEN
		
			IF (RMLORRYNO IS NOT NULL OR RMTHROW_EARTH_STORE IS NOT NULL OR RMTHROW_EARTH_OUTSIDE IS NOT NULL OR RMSTARTTIME IS NOT NULL OR RMENDTIME IS NOT NULL) THEN
			
				INSERT INTO LMC_RENTAL_MACHINERY_DETAILS(TRD_ID,RMD_LORRY_NO,RMD_THROWEARTH_STORE,RMD_THROWEARTH_OUTSIDE,RMD_START_TIME,RMD_END_TIME,RMD_REMARK,ULD_ID)VALUES 
				(TRDID,RMLORRYNO,RMTHROW_EARTH_STORE,RMTHROW_EARTH_OUTSIDE,RMSTARTTIME,RMENDTIME,RMREMARK,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
		
			END IF;
	
		END IF;

		IF SEARCH_OPTION=2 THEN

			IF (LMC_RMDID IS NULL) AND (RMLORRYNO IS NOT NULL OR RMTHROW_EARTH_STORE IS NOT NULL OR RMTHROW_EARTH_OUTSIDE IS NOT NULL OR RMSTARTTIME IS NOT NULL OR RMENDTIME IS NOT NULL) THEN
				
				INSERT INTO LMC_RENTAL_MACHINERY_DETAILS(TRD_ID,RMD_LORRY_NO,RMD_THROWEARTH_STORE,RMD_THROWEARTH_OUTSIDE,RMD_START_TIME,RMD_END_TIME,RMD_REMARK,ULD_ID)VALUES 
				(TRDID,RMLORRYNO,RMTHROW_EARTH_STORE,RMTHROW_EARTH_OUTSIDE,RMSTARTTIME,RMENDTIME,RMREMARK,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
		
			END IF;

			IF (LMC_RMDID IS NOT NULL) AND (RMLORRYNO IS NOT NULL OR RMTHROW_EARTH_STORE IS NOT NULL OR RMTHROW_EARTH_OUTSIDE IS NOT NULL OR RMSTARTTIME IS NOT NULL OR RMENDTIME IS NOT NULL) THEN
			
				UPDATE LMC_RENTAL_MACHINERY_DETAILS SET TRD_ID=TRDID,RMD_LORRY_NO=RMLORRYNO,RMD_THROWEARTH_STORE=RMTHROW_EARTH_STORE,RMD_THROWEARTH_OUTSIDE=RMTHROW_EARTH_OUTSIDE,RMD_START_TIME=RMSTARTTIME,RMD_END_TIME=RMENDTIME,RMD_REMARK=RMREMARK,ULD_ID=(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP) WHERE RMD_ID=LMC_RMDID;
		
			END IF;
	
		END IF;

		IF @RM_LORRYNO IS NULL THEN
			LEAVE  MAIN_LOOP;
		END IF;

	END LOOP;
	
	SET SUCCESS_MESSAGE=1;

END;