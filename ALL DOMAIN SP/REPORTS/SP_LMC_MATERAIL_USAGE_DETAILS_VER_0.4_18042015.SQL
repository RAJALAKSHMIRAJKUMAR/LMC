-- VERSION:0.4 --DATE:18/04/2015 --DESC:ADDED ULD_ID IN LMC_MATERIAL_USAGE TABLE INSERT QUERY--DONE BY:RL
-- VERSION:0.3--DATE:07/04/2015 --DESC:CHANGED MANDATORY FIELD AS NON MANDATORY --DONE BY:DHIVYA
-- VERSION:0.2 --DATE:26/03/2015 --DESC:EMP_ID CHANGED AS ULD_ID IN TICKLER HISTORY,LMC_TEAM_REPORT_DETAILS --DONE BY:RL
-- VER0.1 DATE:05/03/2015 ISSUE:2 DESC:SP FOR INSERT,UPDATE & DELETE LMC_MATERAIL_USAGE_DETAILS done by:dhivya


DROP PROCEDURE IF EXISTS SP_LMC_MATERAIL_USAGE_DETAILS;
CREATE PROCEDURE SP_LMC_MATERAIL_USAGE_DETAILS(
IN SEARCH_OPTION INTEGER,
IN MUDID TEXT,
IN TRDID INTEGER,
IN ITEMS TEXT,
IN RECEIPTNO TEXT,
IN QUANTITY TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_MESSAGE TEXT)

BEGIN

	DECLARE MUITEMS VARCHAR(50);
	DECLARE MURECEIPTNO VARCHAR(25);
	DECLARE MUQUANTITY INTEGER;
	DECLARE MUID INTEGER;
	DECLARE T_MUD_ID TEXT;
	DECLARE TICK_T_MUDID TEXT;
	DECLARE LMC_MUDID INTEGER;
	DECLARE T_MUID INTEGER;
	DECLARE T_RECEIPT_NO VARCHAR(25);
	DECLARE T_QUANTITY INTEGER;
	DECLARE T_ULDID INTEGER;
	DECLARE T_TIMESTAMP TIMESTAMP;
	DECLARE OLDVALUE TEXT;

	SET @M_ITEMS=ITEMS;
	SET @M_RECEIPTNO=RECEIPTNO;
	SET @M_QUANTITY=QUANTITY;
	SET @LMCMUDID=MUDID;

	SET SUCCESS_MESSAGE=0;

	IF SEARCH_OPTION=2 THEN

		SET T_MUD_ID=(SELECT REPLACE(MUDID,' ','0'));
		
		SET @SETLMC_MUD_ID=(SELECT CONCAT('SELECT GROUP_CONCAT(MUD_ID) INTO @L_MUDID FROM LMC_MATERIAL_USAGE_DETAILS WHERE TRD_ID=',TRDID,' AND MUD_ID NOT IN(',T_MUD_ID,')'));
		PREPARE SETLMC_MUD_ID_STMT FROM @SETLMC_MUD_ID;
		EXECUTE SETLMC_MUD_ID_STMT;

		SET T_MUD_ID=@L_MUDID;

		IF T_MUD_ID=' ' THEN
			SET T_MUD_ID=NULL;
		END IF;

		IF T_MUD_ID IS NOT NULL THEN
			SET @TICK_T_MUDID=T_MUD_ID;

			MAIN_LOOP : LOOP

				CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TICK_T_MUDID,@VALUE,@REMAINING_STRING);
				SELECT @VALUE INTO LMC_MUDID;
				SELECT @REMAINING_STRING INTO @TICK_T_MUDID;

				SET T_MUID=(SELECT MU_ID FROM LMC_MATERIAL_USAGE_DETAILS WHERE MUD_ID=LMC_MUDID);

				IF T_MUID IS NULL  THEN
					SET T_MUID='<NULL>';
				END IF;

				SET T_RECEIPT_NO=(SELECT MUD_RECEIPT_NO FROM LMC_MATERIAL_USAGE_DETAILS WHERE MUD_ID=LMC_MUDID);
				
				IF T_RECEIPT_NO IS NULL THEN
					SET T_RECEIPT_NO='<NULL>';
				END IF;
				
				SET T_QUANTITY=(SELECT MUD_QUANTITY FROM LMC_MATERIAL_USAGE_DETAILS WHERE MUD_ID=LMC_MUDID);
				
				IF T_QUANTITY IS NULL THEN
					SET T_QUANTITY='<NULL>';
				END IF;
				
				SET T_ULDID=(SELECT ULD_ID FROM LMC_MATERIAL_USAGE_DETAILS WHERE MUD_ID=LMC_MUDID);
				SET T_TIMESTAMP=(SELECT MUD_TIMESTAMP FROM LMC_MATERIAL_USAGE_DETAILS WHERE MUD_ID=LMC_MUDID);

				SET OLDVALUE=(SELECT CONCAT('MUD_ID=',LMC_MUDID,',TRD_ID=',TRDID,',MU_ID=',T_MUID,',MUD_RECEIPT_NO=',T_RECEIPT_NO,',MUD_QUANTITY=',T_QUANTITY,
				',ULD_ID=',T_ULDID,',MUD_TIMESTAMP=',T_TIMESTAMP));

				INSERT INTO LMC_TICKLER_HISTORY(TP_ID,ULD_ID,TTIP_ID,TH_OLD_VALUE,TH_USERSTAMP_ID)VALUES
				((SELECT TP_ID FROM LMC_TICKLER_PROFILE WHERE TP_TYPE='DELETION'),(SELECT ULD_ID FROM LMC_TEAM_REPORT_DETAILS WHERE TRD_ID=TRDID),
				(SELECT TTIP_ID FROM LMC_TICKLER_TABID_PROFILE WHERE TTIP_DATA='LMC_MATERIAL_USAGE_DETAILS'),OLDVALUE,
				(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
				
				DELETE FROM LMC_MATERIAL_USAGE_DETAILS WHERE  MUD_ID=LMC_MUDID;

				IF @TICK_T_MUDID IS NULL THEN
					LEAVE  MAIN_LOOP;
				END IF;

			END LOOP;

		END IF;

	END IF;

	MAIN_LOOP : LOOP
		
		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@M_ITEMS,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO MUITEMS;
		SELECT @REMAINING_STRING INTO @M_ITEMS;
		
		IF MUITEMS=' ' THEN
			SET MUITEMS=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@M_RECEIPTNO,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO MURECEIPTNO;
		SELECT @REMAINING_STRING INTO @M_RECEIPTNO;
		
		IF MURECEIPTNO=' ' THEN
			SET MURECEIPTNO=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@M_QUANTITY,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO MUQUANTITY;
		SELECT @REMAINING_STRING INTO @M_QUANTITY;
		
		IF MUQUANTITY=' ' THEN
			SET MUQUANTITY=NULL;
		END IF;

		IF NOT EXISTS(SELECT MU_ID FROM LMC_MATERIAL_USAGE WHERE MU_ITEMS=MUITEMS)THEN
			INSERT INTO LMC_MATERIAL_USAGE(MU_ITEMS,ULD_ID)VALUES(MUITEMS,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
			SET MUID=(SELECT MU_ID FROM LMC_MATERIAL_USAGE WHERE MU_ITEMS=MUITEMS);
		ELSE
			SET MUID=(SELECT MU_ID FROM LMC_MATERIAL_USAGE WHERE MU_ITEMS=MUITEMS);

		END IF;

		IF SEARCH_OPTION=2 THEN
			CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@LMCMUDID,@VALUE,@REMAINING_STRING);
			SELECT @VALUE INTO LMC_MUDID;
			SELECT @REMAINING_STRING INTO @LMCMUDID;
		END IF;

		IF LMC_MUDID=' ' THEN
			SET LMC_MUDID=NULL;
		END IF; 

		IF SEARCH_OPTION=1 THEN
		
			IF ITEMS IS NOT NULL THEN

				IF NOT EXISTS(SELECT MUD_ID FROM LMC_MATERIAL_USAGE_DETAILS WHERE TRD_ID=TRDID AND MU_ID=MUID)THEN

					INSERT INTO LMC_MATERIAL_USAGE_DETAILS(TRD_ID,MU_ID,MUD_RECEIPT_NO,MUD_QUANTITY,ULD_ID)VALUES 
					(TRDID,MUID,MURECEIPTNO,MUQUANTITY,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
				
				END IF;
	
			END IF;
	
		END IF;

		IF SEARCH_OPTION=2 THEN
		
			IF LMC_MUDID IS NULL AND ITEMS IS NOT NULL  THEN
			
				IF NOT EXISTS(SELECT MUD_ID FROM LMC_MATERIAL_USAGE_DETAILS WHERE TRD_ID=TRDID AND MU_ID=MUID)THEN

					INSERT INTO LMC_MATERIAL_USAGE_DETAILS(TRD_ID,MU_ID,MUD_RECEIPT_NO,MUD_QUANTITY,ULD_ID)VALUES 
					(TRDID,MUID,MURECEIPTNO,MUQUANTITY,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
			
				END IF;
			
			END IF;

			IF LMC_MUDID IS NOT NULL AND ITEMS IS NOT NULL  THEN
			
				UPDATE LMC_MATERIAL_USAGE_DETAILS SET TRD_ID=TRDID,MU_ID=MUID,MUD_RECEIPT_NO=MURECEIPTNO,MUD_QUANTITY=MUQUANTITY,ULD_ID=(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP) WHERE MUD_ID=LMC_MUDID;
		
			END IF;
	
		END IF;

		IF @M_ITEMS IS NULL THEN
			LEAVE  MAIN_LOOP;
		END IF;

	END LOOP;

	SET SUCCESS_MESSAGE=1;

END;