-- VERSION:0.4 --DATE:18/04/2015 --DESC:ADDED MI_ITEM CHANGES AS MT_ID IN LMC_MACHINERY_EQUIPMENT_TRANSFER TABLE INSERT QUERY & ADDED LMC_MACHINERY_ITEM TABLE INSERT QUERY--DONE BY:RL
-- VERSION:0.3--DATE:07/04/2015 --DESC:CHANGED MANDATORY FIELD AS NON MANDATORY --DONE BY:DHIVYA
-- VERSION:0.2 --DATE:26/03/2015 --DESC:EMP_ID CHANGED AS ULD_ID IN TICKLER HISTORY,LMC_TEAM_REPORT_DETAILS --DONE BY:RL
-- VER0.1 DATE:05/03/2015 ISSUE:2 DESC:SP FOR INSERT,UPDATE & DELETE LMC_MACHINERY_EQUIPMENT_TRANSFER done by:dhivya


DROP PROCEDURE IF EXISTS SP_LMC_MACHINERY_EQUIPMENT_TRANSFER;
CREATE PROCEDURE SP_LMC_MACHINERY_EQUIPMENT_TRANSFER(
IN SEARCH_OPTION INTEGER,
IN METID TEXT,
IN TRDID INTEGER,
IN FROM_LORRYNO TEXT,
IN TO_LORRYNO TEXT,
IN ITEM TEXT,
IN REMARK TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_MESSAGE TEXT)

BEGIN

	DECLARE MAC_FROM_LORRYNO VARCHAR(20);
	DECLARE MAC_TO_LORRYNO VARCHAR(20);
	DECLARE MAC_ITEM VARCHAR(30);
	DECLARE MAC_REMARK TEXT;
	DECLARE T_MET_ID TEXT;
	DECLARE LMC_METID INTEGER;
	DECLARE T_FROM_LORRY_NO VARCHAR(20);
	DECLARE T_TO_LORRY_NO VARCHAR(20);
	DECLARE T_ITEM VARCHAR(30);
	DECLARE T_REMARK TEXT;
	DECLARE T_ULDID INTEGER;
	DECLARE T_TIMESTAMP TIMESTAMP;
	DECLARE OLDVALUE TEXT;
	DECLARE MIID INTEGER;


	SET @MACFROMLORRYNO=FROM_LORRYNO;
	SET @MACTOLORRYNO=TO_LORRYNO;
	SET @MACITEM=ITEM;
	SET @MACHREMARK=REMARK;
	SET @LMCMETID=METID;

	SET SUCCESS_MESSAGE=0;

	IF SEARCH_OPTION=2 THEN

		SET T_MET_ID=(SELECT REPLACE(METID,' ','0'));
		SET @SETLMC_METID=(SELECT CONCAT('SELECT GROUP_CONCAT(MET_ID) INTO @L_METID FROM LMC_MACHINERY_EQUIPMENT_TRANSFER WHERE
		TRD_ID=',TRDID,' AND MET_ID NOT IN(',T_MET_ID,')'));
		PREPARE SETLMC_METID_STMT FROM @SETLMC_METID;
		EXECUTE SETLMC_METID_STMT;

		SET T_MET_ID=@L_METID;

		IF T_MET_ID=' ' THEN
			SET T_MET_ID=NULL;
		END IF;

		IF T_MET_ID IS NOT NULL THEN
			SET @TICK_T_METID=T_MET_ID;

			MAIN_LOOP : LOOP

				CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TICK_T_METID,@VALUE,@REMAINING_STRING);
				SELECT @VALUE INTO LMC_METID;
				SELECT @REMAINING_STRING INTO @TICK_T_METID;

				SET T_FROM_LORRY_NO=(SELECT MET_FROM_LORRY_NO FROM LMC_MACHINERY_EQUIPMENT_TRANSFER WHERE MET_ID=LMC_METID);
				
				IF T_FROM_LORRY_NO IS NULL  THEN
					SET T_FROM_LORRY_NO='<NULL>';
				END IF;

				SET T_TO_LORRY_NO=(SELECT MET_TO_LORRY_NO FROM LMC_MACHINERY_EQUIPMENT_TRANSFER WHERE MET_ID=LMC_METID);
				
				IF T_TO_LORRY_NO IS NULL THEN
					SET T_TO_LORRY_NO='<NULL>';
				END IF;

				SET T_ITEM=(SELECT MI_ID FROM LMC_MACHINERY_EQUIPMENT_TRANSFER WHERE MET_ID=LMC_METID);
				
				IF T_ITEM IS NULL THEN
					SET T_ITEM='<NULL>';
				END IF;

				SET T_ULDID=(SELECT ULD_ID FROM LMC_MACHINERY_EQUIPMENT_TRANSFER WHERE MET_ID=LMC_METID);
				SET T_TIMESTAMP=(SELECT MET_TIMESTAMP FROM LMC_MACHINERY_EQUIPMENT_TRANSFER WHERE MET_ID=LMC_METID);

				SET OLDVALUE=(SELECT CONCAT('MET_ID=',LMC_METID,',TRD_ID=',TRDID,',MET_FROM_LORRY_NO=',T_FROM_LORRY_NO,
				',MET_TO_LORRY_NO=',T_TO_LORRY_NO,',MI_ID=',T_ITEM,',ULD_ID=',T_ULDID,',MET_TIMESTAMP=',T_TIMESTAMP));

				INSERT INTO LMC_TICKLER_HISTORY(TP_ID,ULD_ID,TTIP_ID,TH_OLD_VALUE,TH_USERSTAMP_ID)VALUES
				((SELECT TP_ID FROM LMC_TICKLER_PROFILE WHERE TP_TYPE='DELETION'),(SELECT ULD_ID FROM LMC_TEAM_REPORT_DETAILS WHERE 
				TRD_ID=TRDID),(SELECT TTIP_ID FROM LMC_TICKLER_TABID_PROFILE WHERE TTIP_DATA='LMC_MACHINERY_EQUIPMENT_TRANSFER'),OLDVALUE,
				(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));

				DELETE FROM LMC_MACHINERY_EQUIPMENT_TRANSFER WHERE  MET_ID=LMC_METID;

				IF @TICK_T_METID IS NULL THEN
					LEAVE  MAIN_LOOP;
				END IF;

			END LOOP;

		END IF;

	END IF;

	MAIN_LOOP : LOOP
		
		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@MACFROMLORRYNO,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO MAC_FROM_LORRYNO;
		SELECT @REMAINING_STRING INTO @MACFROMLORRYNO;

		IF MAC_FROM_LORRYNO=' ' THEN
			SET MAC_FROM_LORRYNO=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@MACTOLORRYNO,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO MAC_TO_LORRYNO;
		SELECT @REMAINING_STRING INTO @MACTOLORRYNO;

		IF MAC_TO_LORRYNO=' ' THEN
			SET MAC_TO_LORRYNO=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',  @MACITEM,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO MAC_ITEM;
		SELECT @REMAINING_STRING INTO @MACITEM;

		IF MAC_ITEM=' ' THEN
			SET MAC_ITEM=NULL;
		END IF;

		SET MIID = (SELECT MI_ID FROM LMC_MACHINERY_ITEM WHERE MI_ITEM=MAC_ITEM);

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@MACHREMARK,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO MAC_REMARK;
		SELECT @REMAINING_STRING INTO @MACHREMARK;

		IF MAC_REMARK='' THEN
			SET MAC_REMARK=NULL;
		END IF;

		IF SEARCH_OPTION=2 THEN
			CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@LMCMETID,@VALUE,@REMAINING_STRING);
			SELECT @VALUE INTO LMC_METID;
			SELECT @REMAINING_STRING INTO @LMCMETID;
		END IF;

		IF LMC_METID=' ' THEN
			SET LMC_METID=NULL;
		END IF;

		IF SEARCH_OPTION=1 THEN
		
			IF MAC_FROM_LORRYNO IS NOT NULL OR  MAC_TO_LORRYNO IS NOT NULL OR MIID IS NOT NULL OR MAC_REMARK IS NOT NULL THEN

				INSERT INTO LMC_MACHINERY_EQUIPMENT_TRANSFER(TRD_ID,MET_FROM_LORRY_NO,MET_TO_LORRY_NO,MI_ID,MET_REMARK,ULD_ID)VALUES 
				(TRDID,MAC_FROM_LORRYNO,MAC_TO_LORRYNO,MIID,MAC_REMARK,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
		
			END IF;

		END IF;

		IF SEARCH_OPTION=2 THEN
		
			IF (LMC_METID IS NULL) AND ((MAC_FROM_LORRYNO IS NOT NULL OR  MAC_TO_LORRYNO IS NOT NULL OR MIID IS NOT NULL OR 
			MAC_REMARK IS NOT NULL)) THEN
				
				INSERT INTO LMC_MACHINERY_EQUIPMENT_TRANSFER(TRD_ID,MET_FROM_LORRY_NO,MET_TO_LORRY_NO,MI_ID,MET_REMARK,ULD_ID)VALUES 
				(TRDID,MAC_FROM_LORRYNO,MAC_TO_LORRYNO,MIID,MAC_REMARK,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
		
			END IF;

			IF LMC_METID IS NOT NULL AND ((MAC_FROM_LORRYNO IS NOT NULL OR  MAC_TO_LORRYNO IS NOT NULL OR MIID IS NOT NULL OR 
			MAC_REMARK IS NOT NULL)) THEN
				
				UPDATE LMC_MACHINERY_EQUIPMENT_TRANSFER SET TRD_ID=TRDID,MET_FROM_LORRY_NO=MAC_FROM_LORRYNO,MET_TO_LORRY_NO=MAC_TO_LORRYNO,
				MI_ID=MIID,MET_REMARK=MAC_REMARK,ULD_ID=(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP) 
				WHERE MET_ID=LMC_METID;
			
			END IF;
		END IF;

		IF  @MACFROMLORRYNO IS NULL THEN
			LEAVE  MAIN_LOOP;
		END IF;

	END LOOP;

	SET SUCCESS_MESSAGE=1;

END;