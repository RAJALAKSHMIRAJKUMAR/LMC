-- VERSION:0.3--DATE:07/04/2015 --DESC:CHANGED MANDATORY FIELD AS NON MANDATORY --DONE BY:DHIVYA
-- VERSION:0.2 --DATE:26/03/2015 --DESC:EMP_ID CHANGED AS ULD_ID IN TICKLER HISTORY,LMC_TEAM_REPORT_DETAILS --DONE BY:RL
-- VER0.1 DATE:05/03/2015 ISSUE:2 DESC:SP FOR INSERT,UPDATE & DELETE FOR LMC_TEAM_JOB done by:dhivya

DROP PROCEDURE IF EXISTS SP_LMC_TEAM_JOB;
CREATE PROCEDURE SP_LMC_TEAM_JOB(
IN SEARCH_OPTION INTEGER,
IN TRDID INTEGER,
IN PIPE_LAID TEXT,
IN SIZE TEXT,
IN LENGTH TEXT,
USERSTAMP VARCHAR(50),
OUT SUCCESS_MESSAGE TEXT)

BEGIN

	DECLARE LMC_PIPE_LAID VARCHAR(20);
	DECLARE LMC_SIZE INTEGER;
	DECLARE LMC_LENGTH INTEGER;
	DECLARE T_TJID TEXT;
	DECLARE LMC_TJID INTEGER;
	DECLARE T_PIPE_LAID VARCHAR(20);
	DECLARE T_SIZE INTEGER;
	DECLARE T_LENGTH INTEGER;
	DECLARE T_ULDID INTEGER;
	DECLARE T_TIMESTAMP TIMESTAMP;
	DECLARE OLDVALUE TEXT;
	DECLARE D_TJID TEXT;
	DECLARE TJID TEXT;

	SET @LMCPIPELAID=PIPE_LAID;
	SET @PIPE_LAID=PIPE_LAID;
	SET @LMCSIZE=SIZE;
	SET @LMCLENGTH=LENGTH;
	SET SUCCESS_MESSAGE=0;

	IF SEARCH_OPTION=2 THEN

		SET D_TJID='';

		MAIN_LOOP : LOOP

			CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@LMCPIPELAID,@VALUE,@REMAINING_STRING);
			SELECT @VALUE INTO LMC_PIPE_LAID;
			SELECT @REMAINING_STRING INTO @LMCPIPELAID;

			IF EXISTS(SELECT TJ_ID FROM LMC_TEAM_JOB WHERE TRD_ID=TRDID AND TJ_PIPE_LAID=LMC_PIPE_LAID) THEN
		
				IF LMC_PIPE_LAID IS NOT NULL THEN
			
					SET D_TJID=(SELECT CONCAT(D_TJID,',',(SELECT TJ_ID FROM LMC_TEAM_JOB WHERE TRD_ID=TRDID AND TJ_PIPE_LAID=LMC_PIPE_LAID)));
		
				END IF;

			END IF;

			IF @LMCPIPELAID IS NULL THEN
				LEAVE  MAIN_LOOP;
			END IF;

		END LOOP;

		SET D_TJID=(SELECT SUBSTRING(D_TJID,2));
		SET TJID=D_TJID;

		SET @CHECKTJID=D_TJID;
		SET TJID=(SELECT TRIM(TJID));

		IF TJID IS NULL OR TJID='' THEN
			SET TJID=0;
		END IF;

		SET @SETLMC_TJID=(SELECT CONCAT('SELECT GROUP_CONCAT(TJ_ID) INTO @L_TJID FROM LMC_TEAM_JOB WHERE TRD_ID=',TRDID,' AND TJ_ID NOT IN(',TJID,')'));
		PREPARE SETLMC_TJID_STMT FROM @SETLMC_TJID;
		EXECUTE SETLMC_TJID_STMT;

		SET T_TJID=@L_TJID;
		IF T_TJID='' THEN
			SET T_TJID=NULL;
		END IF;

		IF T_TJID IS NOT NULL THEN
			
			SET @TICK_T_TJID=T_TJID;
		
			MAIN_LOOP : LOOP

				CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TICK_T_TJID,@VALUE,@REMAINING_STRING);
				SELECT @VALUE INTO LMC_TJID;
				SELECT @REMAINING_STRING INTO @TICK_T_TJID;

				SET T_PIPE_LAID=(SELECT TJ_PIPE_LAID FROM LMC_TEAM_JOB WHERE TJ_ID=LMC_TJID);
				IF T_PIPE_LAID IS NULL  THEN
					SET T_PIPE_LAID='<NULL>';
				END IF;

				SET T_SIZE=(SELECT TJ_SIZE FROM LMC_TEAM_JOB WHERE TJ_ID=LMC_TJID);
				IF T_SIZE IS NULL THEN
					SET T_SIZE='<NULL>';
				END IF;

				SET T_LENGTH=(SELECT TJ_LENGTH FROM LMC_TEAM_JOB WHERE TJ_ID=LMC_TJID);
				IF T_LENGTH IS NULL THEN
					SET T_LENGTH='<NULL>';
				END IF;

				SET T_ULDID=(SELECT ULD_ID FROM LMC_TEAM_JOB WHERE TJ_ID=LMC_TJID);
				SET T_TIMESTAMP=(SELECT TJ_TIMESTAMP FROM LMC_TEAM_JOB WHERE TJ_ID=LMC_TJID);

				SET OLDVALUE=(SELECT CONCAT('TJ_ID=',LMC_TJID,',TRD_ID=',TRDID,',TJ_PIPE_LAID=',T_PIPE_LAID,',TJ_SIZE=',T_SIZE,',TJ_LENGTH=',T_LENGTH,
				',ULD_ID=',T_ULDID,',TJ_TIMESTAMP=',T_TIMESTAMP));

				INSERT INTO LMC_TICKLER_HISTORY(TP_ID,ULD_ID,TTIP_ID,TH_OLD_VALUE,TH_USERSTAMP_ID)VALUES
				((SELECT TP_ID FROM LMC_TICKLER_PROFILE WHERE TP_TYPE='DELETION'),(SELECT ULD_ID FROM LMC_TEAM_REPORT_DETAILS WHERE TRD_ID=TRDID),
				(SELECT TTIP_ID FROM LMC_TICKLER_TABID_PROFILE WHERE TTIP_DATA='LMC_TEAM_JOB'),OLDVALUE,
				(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
				DELETE FROM LMC_TEAM_JOB WHERE TJ_ID=LMC_TJID;

				IF @TICK_T_TJID IS NULL THEN
					LEAVE  MAIN_LOOP;
				END IF;

			END LOOP;

		END IF;

	END IF;


	MAIN_LOOP : LOOP
		
		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@PIPE_LAID,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO LMC_PIPE_LAID;
		SELECT @REMAINING_STRING INTO @PIPE_LAID;
	
		IF LMC_PIPE_LAID=''  THEN
			SET LMC_PIPE_LAID=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@LMCSIZE,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO LMC_SIZE;
		SELECT @REMAINING_STRING INTO @LMCSIZE;

		IF LMC_SIZE='' THEN
			SET LMC_SIZE=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@LMCLENGTH,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO LMC_LENGTH;
		SELECT @REMAINING_STRING INTO @LMCLENGTH;

		IF LMC_LENGTH='' THEN
			SET LMC_LENGTH=NULL;
		END IF;

		IF SEARCH_OPTION=2 THEN
			SET LMC_TJID=(SELECT TJ_ID FROM LMC_TEAM_JOB WHERE TRD_ID=TRDID AND TJ_PIPE_LAID=LMC_PIPE_LAID);
		END IF;

		IF SEARCH_OPTION=1 THEN
			
			IF (LMC_PIPE_LAID IS NOT NULL OR  LMC_SIZE IS NOT NULL OR LMC_LENGTH IS NOT NULL) THEN

				INSERT INTO LMC_TEAM_JOB(TRD_ID,TJ_PIPE_LAID,TJ_SIZE,TJ_LENGTH,ULD_ID)VALUES 
				(TRDID,LMC_PIPE_LAID,LMC_SIZE,LMC_LENGTH,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
			
			END IF;

		END IF;

		IF SEARCH_OPTION=2 THEN
			
			IF (LMC_TJID IS NULL) AND (LMC_PIPE_LAID IS NOT NULL OR  LMC_SIZE IS NOT NULL OR LMC_LENGTH IS NOT NULL) THEN
				
				INSERT INTO LMC_TEAM_JOB(TRD_ID,TJ_PIPE_LAID,TJ_SIZE,TJ_LENGTH,ULD_ID)VALUES 
				(TRDID,LMC_PIPE_LAID,LMC_SIZE,LMC_LENGTH,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
			
			END IF;
			
			IF (LMC_TJID IS NOT NULL) AND (LMC_PIPE_LAID IS NOT NULL OR  LMC_SIZE IS NOT NULL OR LMC_LENGTH IS NOT NULL) THEN
				
				UPDATE LMC_TEAM_JOB SET TRD_ID=TRDID,TJ_PIPE_LAID=LMC_PIPE_LAID,TJ_SIZE=LMC_SIZE,TJ_LENGTH=LMC_LENGTH,ULD_ID=(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP) WHERE TJ_ID=LMC_TJID; 
			
			END IF;
		
		END IF;

		IF  @PIPE_LAID IS NULL THEN
			LEAVE  MAIN_LOOP;
		END IF;
		
		SET LMC_TJID=NULL;

	END LOOP;

	SET SUCCESS_MESSAGE=1;

END;