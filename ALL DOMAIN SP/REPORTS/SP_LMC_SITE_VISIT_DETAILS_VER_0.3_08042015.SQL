-- VERSION:0.2 --DATE:26/03/2015 --DESC:EMP_ID CHANGED AS ULD_ID IN TICKLER HISTORY,LMC_TEAM_REPORT_DETAILS --DONE BY:RL
-- VER0.1 DATE:05/03/2015 ISSUE:2 DESC:SP FOR INSERT,UPDATE & DELETE FOR LMC_SITE_VISIT_DETAILS done by:dhivya


DROP PROCEDURE IF EXISTS SP_LMC_SITE_VISIT_DETAILS;
CREATE PROCEDURE SP_LMC_SITE_VISIT_DETAILS(
IN SEARCH_OPTION INTEGER,
IN TRDID INTEGER,
IN SVDID TEXT,
IN NAME TEXT,
IN DESIGNATION TEXT,
IN STARTTIME TEXT,
IN ENDTIME TEXT,
IN REMARK TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_MESSAGE TEXT)

BEGIN

	DECLARE SV_NAME CHAR(50);
	DECLARE SV_DESIGNATION VARCHAR(50);
	DECLARE SV_STIME TIME;
	DECLARE SV_ETIME TIME;
	DECLARE SV_REMARK TEXT;
	DECLARE LMC_SVDID INTEGER;
	DECLARE LMSVDID INTEGER;
	DECLARE T_SVDID INTEGER;
	DECLARE T_TRD_ID INTEGER;
	DECLARE T_SVD_NAME CHAR(50);
	DECLARE T_SVD_DESIG VARCHAR(50);
	DECLARE T_SVD_START_TIME TIME;
	DECLARE T_SVD_END_TIME TIME;
	DECLARE T_SVD_REMARK TEXT;
	DECLARE T_ULD_ID INTEGER;
	DECLARE T_SVD_TIMESTAMP TIMESTAMP;
	DECLARE OLDVALUE TEXT;
	DECLARE TICKSVIDID TEXT;
	DECLARE TSVDID TEXT;

	SET SUCCESS_MESSAGE=0;

	IF SEARCH_OPTION=2 THEN

		SET TSVDID=(SELECT REPLACE(SVDID,' ','0'));
		SET @SETLMC_SVDID=(SELECT CONCAT('SELECT GROUP_CONCAT(SVD_ID) INTO @L_SVID FROM LMC_SITE_VISIT_DETAILS WHERE TRD_ID=',TRDID,' AND SVD_ID NOT IN(',TSVDID,')'));
		PREPARE SETLMC_SVDID_STMT FROM @SETLMC_SVDID;
		EXECUTE SETLMC_SVDID_STMT;

		SET TICKSVIDID=@L_SVID;
		IF TICKSVIDID=' ' THEN
			SET TICKSVIDID=NULL;
		END IF;

		IF TICKSVIDID IS NOT NULL THEN
			SET @TICK_SVDID=TICKSVIDID;

			MAIN_LOOP : LOOP

				CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',', @TICK_SVDID,@VALUE,@REMAINING_STRING);
				SELECT @VALUE INTO LMSVDID;
				SELECT @REMAINING_STRING INTO @TICK_SVDID;

				SET T_SVDID=(SELECT SVD_ID FROM LMC_SITE_VISIT_DETAILS WHERE SVD_ID=LMSVDID);
				SET T_TRD_ID=(SELECT TRD_ID FROM LMC_SITE_VISIT_DETAILS WHERE SVD_ID=LMSVDID);
				SET T_SVD_NAME=(SELECT SVD_NAME FROM LMC_SITE_VISIT_DETAILS WHERE SVD_ID=LMSVDID);
				SET T_SVD_DESIG=(SELECT SVD_DESIGNATION FROM LMC_SITE_VISIT_DETAILS WHERE SVD_ID=LMSVDID);
				SET T_SVD_START_TIME=(SELECT SVD_START_TIME FROM LMC_SITE_VISIT_DETAILS WHERE SVD_ID=LMSVDID);
				SET T_SVD_END_TIME=(SELECT SVD_END_TIME FROM LMC_SITE_VISIT_DETAILS WHERE SVD_ID=LMSVDID);
				SET T_SVD_REMARK=(SELECT SVD_REMARK FROM LMC_SITE_VISIT_DETAILS WHERE SVD_ID=LMSVDID);
				SET T_ULD_ID=(SELECT ULD_ID FROM LMC_SITE_VISIT_DETAILS WHERE SVD_ID=LMSVDID);
				SET T_SVD_TIMESTAMP=(SELECT SVD_TIMESTAMP FROM LMC_SITE_VISIT_DETAILS WHERE SVD_ID=LMSVDID);

				IF T_SVD_NAME IS NULL THEN
					SET T_SVD_NAME='<NULL>';
				END IF;

				IF T_SVD_DESIG IS NULL THEN
					SET T_SVD_DESIG='<NULL>';
				END IF;

				IF T_SVD_START_TIME IS NULL THEN
					SET T_SVD_START_TIME='<NULL>';
				END IF;

				IF T_SVD_END_TIME IS NULL THEN
					SET T_SVD_END_TIME='<NULL>';
				END IF;

				IF T_SVD_REMARK IS NULL THEN
					SET T_SVD_REMARK='<NULL>';
				END IF;

				SET OLDVALUE=(SELECT CONCAT('SVD_ID=',T_SVDID,',TRD_ID=',T_TRD_ID,',SVD_NAME=',T_SVD_NAME,',SVD_DESIGNATION=',T_SVD_DESIG,',SVD_START_TIME=',T_SVD_START_TIME,
				',SVD_END_TIME=',T_SVD_END_TIME,',SVD_REMARK=',T_SVD_REMARK,',ULD_ID=',T_ULD_ID,',SVD_TIMESTAMP=',T_SVD_TIMESTAMP));
			
				DELETE FROM LMC_SITE_VISIT_DETAILS WHERE SVD_ID=LMSVDID;

				INSERT INTO LMC_TICKLER_HISTORY(TP_ID,ULD_ID,TTIP_ID,TH_OLD_VALUE,TH_USERSTAMP_ID)VALUES
				((SELECT TP_ID FROM LMC_TICKLER_PROFILE WHERE TP_TYPE='DELETION'),(SELECT ULD_ID FROM LMC_TEAM_REPORT_DETAILS WHERE TRD_ID=TRDID),
				(SELECT TTIP_ID FROM LMC_TICKLER_TABID_PROFILE WHERE TTIP_DATA='LMC_SITE_VISIT_DETAILS'),OLDVALUE,
				(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
			
				IF @TICK_SVDID IS NULL THEN
					LEAVE  MAIN_LOOP;
				END IF;

			END LOOP;

		END IF;

	END IF;

	SET @SVNAME=NAME;
	SET @SVDESIGNATION=DESIGNATION;
	SET @SVSTIME=STARTTIME;
	SET @SVETIME=ENDTIME;
	SET @SVREMARK=REMARK;
	SET @LMCSVDID=SVDID;
	SET @COUNT=1;

	MAIN_LOOP : LOOP

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@SVNAME,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO SV_NAME;
		SELECT @REMAINING_STRING INTO @SVNAME;

		IF SV_NAME=' ' THEN
			SET SV_NAME=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@SVDESIGNATION,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO SV_DESIGNATION;
		SELECT @REMAINING_STRING INTO @SVDESIGNATION;

		IF SV_DESIGNATION=' ' THEN
			SET SV_DESIGNATION=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@SVSTIME,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO SV_STIME;
		SELECT @REMAINING_STRING INTO @SVSTIME;

		IF SV_STIME='' THEN
			SET SV_STIME=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',@SVETIME,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO SV_ETIME;
		SELECT @REMAINING_STRING INTO @SVETIME;

		IF SV_ETIME='' THEN
			SET SV_ETIME=NULL;
		END IF;

		CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^', @SVREMARK,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO SV_REMARK;
		SELECT @REMAINING_STRING INTO @SVREMARK;

		IF SV_REMARK=' ' THEN
			SET SV_REMARK=NULL;
		END IF;

		IF SEARCH_OPTION=2 THEN
			CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@LMCSVDID,@VALUE,@REMAINING_STRING);
			SELECT @VALUE INTO LMC_SVDID;
			SELECT @REMAINING_STRING INTO @LMCSVDID;
		END IF;

		IF LMC_SVDID=' ' THEN
			SET LMC_SVDID=NULL;
		END IF;
		
		IF SEARCH_OPTION=1 THEN
			
			IF (LMC_SVDID IS NULL) AND (SV_NAME IS NOT NULL OR  SV_DESIGNATION IS NOT NULL OR SV_STIME IS NOT NULL OR SV_ETIME IS NOT NULL) THEN

				INSERT INTO LMC_SITE_VISIT_DETAILS(TRD_ID,SVD_NAME,SVD_DESIGNATION,SVD_START_TIME,SVD_END_TIME,SVD_REMARK,ULD_ID)VALUES 
				(TRDID,SV_NAME,SV_DESIGNATION,SV_STIME,SV_ETIME,SV_REMARK,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
		
			END IF;
		
		END IF;
		
		IF SEARCH_OPTION=2 THEN
			
			IF (LMC_SVDID IS NOT NULL) AND (SV_NAME IS NOT NULL OR  SV_DESIGNATION IS NOT NULL OR SV_STIME IS NOT NULL OR SV_ETIME IS NOT NULL) THEN
				
				UPDATE LMC_SITE_VISIT_DETAILS SET TRD_ID=TRDID,SVD_NAME=SV_NAME,SVD_DESIGNATION=SV_DESIGNATION,SVD_START_TIME=SV_STIME,
				SVD_END_TIME=SV_ETIME,SVD_REMARK=SV_REMARK,ULD_ID=(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP) WHERE SVD_ID=LMC_SVDID;
			
			END IF;
			
			IF (LMC_SVDID IS NULL) AND (SV_NAME IS NOT NULL OR  SV_DESIGNATION IS NOT NULL OR SV_STIME IS NOT NULL OR SV_ETIME IS NOT NULL) THEN
				
				SET @INSERT_FLAG=1;
				INSERT INTO LMC_SITE_VISIT_DETAILS(TRD_ID,SVD_NAME,SVD_DESIGNATION,SVD_START_TIME,SVD_END_TIME,SVD_REMARK,ULD_ID)VALUES 
				(TRDID,SV_NAME,SV_DESIGNATION,SV_STIME,SV_ETIME,SV_REMARK,(SELECT ULD_ID FROM LMC_USER_LOGIN_DETAILS WHERE ULD_USERNAME=USERSTAMP));
			
			END IF;
		
		END IF;

		IF  @SVNAME IS NULL THEN
			LEAVE  MAIN_LOOP;
		END IF;
		
		SET @COUNT=@COUNT+1;

	END LOOP;

	SET SUCCESS_MESSAGE=1;

END;