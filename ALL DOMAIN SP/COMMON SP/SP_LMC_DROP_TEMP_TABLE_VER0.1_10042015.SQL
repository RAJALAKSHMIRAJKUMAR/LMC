-- VER 0.1 DATE:10/04/2015 DESC: SP FOR DROP TEMP TABLE DONE BY:DHIVYA

DROP PROCEDURE IF EXISTS SP_LMC_DROP_TEMP_TABLE;
CREATE PROCEDURE SP_LMC_DROP_TEMP_TABLE()
BEGIN
DECLARE TABLENAME TEXT;
DECLARE TABNAME TEXT;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
ROLLBACK;
END;
START TRANSACTION;
SET AUTOCOMMIT=0;

SET TABLENAME=(SELECT  GROUP_CONCAT(TABLE_NAME)
FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA=(SELECT DATABASE()) AND
TABLE_NAME LIKE 'TEMP_%');

IF TABLENAME IS NOT NULL THEN
	INSERT INTO LMC_TEMP_TABLE_DETAILS(TTD_DATE,TTD_TABLE_NAME)VALUES(CURDATE(),TABLENAME);
END IF;

SET TABNAME=(SELECT  GROUP_CONCAT(TABLE_NAME  SEPARATOR '^')
FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA=(SELECT DATABASE()) AND
TABLE_NAME LIKE 'TEMP_%');

IF TABNAME IS NOT NULL THEN
	MAIN_LOOP : LOOP
			CALL SP_LMC_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^',TABNAME,@VALUE,@REMAINING_STRING);
			SELECT @VALUE INTO TABLENAME;
			SELECT @REMAINING_STRING INTO TABNAME;

			SET @DROP_QUERY=(SELECT CONCAT('DROP TABLE ',TABLENAME));
			PREPARE DROP_QUERY_STMT FROM @DROP_QUERY;
			EXECUTE DROP_QUERY_STMT;
			IF TABNAME IS NULL THEN
			LEAVE  MAIN_LOOP;
			END IF;
	END LOOP;
END IF;
COMMIT;
END;
		
